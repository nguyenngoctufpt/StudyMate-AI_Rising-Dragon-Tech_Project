<!DOCTYPE html>
<html lang="vi" class="light-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyMate AI - Trợ lý học tập thông minh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* CSS styles remain unchanged - keeping all the original styling */
        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --sidebar-gradient-start: #4f46e5;
            --sidebar-gradient-end: #7c3aed;
            --chat-bg-start: #ffffff;
            --chat-bg-end: #f8fafc;
            --chat-header-bg-start: #f8fafc;
            --chat-header-bg-end: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --user-message-gradient-start: #4f46e5;
            --user-message-gradient-end: #7c3aed;
            --user-message-text: white;
            --ai-message-gradient-start: #f1f5f9;
            --ai-message-gradient-end: #e2e8f0;
            --ai-message-text: #1e293b;
            --ai-message-border: #4f46e5;
            --input-bg: #f8fafc;
            --input-border: #e2e8f0;
            --input-focus-border: #4f46e5;
            --hint-bg-start: #fef3c7;
            --hint-bg-end: #fde68a;
            --hint-border: #f59e0b;
            --hint-text: #92400e;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --scrollbar-track: #f1f5f9;
            --scrollbar-thumb-start: #cbd5e1;
            --scrollbar-thumb-end: #94a3b8;
            --scrollbar-thumb-hover-start: #94a3b8;
            --scrollbar-thumb-hover-end: #64748b;
        }

        .dark-theme {
            --bg-gradient-start: #1e293b;
            --bg-gradient-end: #0f172a;
            --sidebar-gradient-start: #312e81;
            --sidebar-gradient-end: #4338ca;
            --chat-bg-start: #1e293b;
            --chat-bg-end: #0f172a;
            --chat-header-bg-start: #1e293b;
            --chat-header-bg-end: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --user-message-gradient-start: #4338ca;
            --user-message-gradient-end: #312e81;
            --user-message-text: white;
            --ai-message-gradient-start: #334155;
            --ai-message-gradient-end: #1e293b;
            --ai-message-text: #f1f5f9;
            --ai-message-border: #6366f1;
            --input-bg: #334155;
            --input-border: #475569;
            --input-focus-border: #6366f1;
            --hint-bg-start: #422006;
            --hint-bg-end: #713f12;
            --hint-border: #b45309;
            --hint-text: #fcd34d;
            --glass-bg: rgba(15, 23, 42, 0.95);
            --scrollbar-track: #1e293b;
            --scrollbar-thumb-start: #475569;
            --scrollbar-thumb-end: #334155;
            --scrollbar-thumb-hover-start: #64748b;
            --scrollbar-thumb-hover-end: #475569;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            color: var(--text-primary);
        }

        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chat-container {
            width: 100%;
            max-width: 1200px;
            height: 80vh;
            min-height: 600px;
            display: flex;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }

        .sidebar {
            width: 300px;
            background: linear-gradient(180deg, var(--sidebar-gradient-start) 0%, var(--sidebar-gradient-end) 100%);
            color: white;
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }

        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--chat-bg-start);
        }

        .chat-header {
            background: linear-gradient(90deg, var(--chat-header-bg-start) 0%, var(--chat-header-bg-end) 100%);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--input-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            background: linear-gradient(180deg, var(--chat-bg-start) 0%, var(--chat-bg-end) 100%);
        }

        .chat-input-area {
            padding: 2rem;
            background: var(--chat-bg-start);
            border-top: 1px solid var(--input-border);
        }

        .message-bubble {
            max-width: 70%;
            margin-bottom: 1.5rem;
            animation: slideIn 0.3s ease-out;
        }

        .user-message {
            margin-left: auto;
            background: linear-gradient(135deg, var(--user-message-gradient-start) 0%, var(--user-message-gradient-end) 100%);
            color: var(--user-message-text);
            padding: 1rem 1.5rem;
            border-radius: 20px 20px 5px 20px;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }

        .ai-message {
            background: linear-gradient(135deg, var(--ai-message-gradient-start) 0%, var(--ai-message-gradient-end) 100%);
            color: var(--ai-message-text);
            padding: 1rem 1.5rem;
            border-radius: 20px 20px 20px 5px;
            border-left: 4px solid var(--ai-message-border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .input-container {
            background: var(--input-bg);
            border: 2px solid var(--input-border);
            border-radius: 16px;
            padding: 1rem;
            display: flex;
            align-items: end;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .input-container:focus-within {
            border-color: var(--input-focus-border);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .message-input {
            flex: 1;
            border: none;
            background: transparent;
            resize: none;
            outline: none;
            font-size: 16px;
            line-height: 1.5;
            max-height: 120px;
            color: var(--text-primary);
        }

        .send-button {
            background: linear-gradient(135deg, var(--user-message-gradient-start) 0%, var(--user-message-gradient-end) 100%);
            color: white;
            border-radius: 12px;
            padding: 12px 16px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 48px;
            height: 48px;
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .command-hint {
            background: linear-gradient(135deg, var(--hint-bg-start) 0%, var(--hint-bg-end) 100%);
            border: 1px solid var(--hint-border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            font-size: 14px;
            color: var(--hint-text);
        }

        @media (max-width: 768px) {
            .chat-container {
                height: 100vh;
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                padding: 1rem;
            }
            
            .message-bubble {
                max-width: 85%;
            }
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--scrollbar-thumb-start) 0%, var(--scrollbar-thumb-end) 100%);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--scrollbar-thumb-hover-start) 0%, var(--scrollbar-thumb-hover-end) 100%);
        }
        
        /* Back button styles */
        .back-button {
            background: linear-gradient(135deg, var(--ai-message-gradient-start) 0%, var(--ai-message-gradient-end) 100%);
            color: var(--user-message-gradient-start);
            border-radius: 12px;
            padding: 8px 16px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: 600;
        }
        
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background: linear-gradient(135deg, var(--scrollbar-thumb-start) 0%, var(--scrollbar-thumb-end) 100%);
        }
        
        .header-content {
            display: flex;
            align-items: center;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        /* Theme toggle button */
        .theme-toggle {
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }
        
        .theme-toggle:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: rotate(15deg);
        }
        
        .theme-toggle svg {
            width: 20px;
            height: 20px;
        }
        
        ::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        /* Notification System */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .notification {
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            transform: translateX(120%);
            opacity: 0;
            animation: slide-in 0.5s forwards, fade-out 0.5s forwards 4.5s;
        }

        .notification-icon {
            margin-right: 12px;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 16px;
        }

        .notification-message {
            font-size: 14px;
            opacity: 0.9;
            line-height: 1.4;
        }

        .notification-close {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
            margin-left: 10px;
            opacity: 0.6;
            transition: opacity 0.2s;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .notification-close:hover {
            opacity: 1;
        }

        /* Notification types */
        .notification-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-left: 4px solid #047857;
        }

        .notification-error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-left: 4px solid #b91c1c;
        }

        .notification-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-left: 4px solid #1d4ed8;
        }

        .notification-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-left: 4px solid #b45309;
        }

        /* Dark mode variants */
        .dark-theme .notification-success {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            border-left: 4px solid #10b981;
        }

        .dark-theme .notification-error {
            background: linear-gradient(135deg, #991b1b 0%, #b91c1c 100%);
            border-left: 4px solid #ef4444;
        }

        .dark-theme .notification-info {
            background: linear-gradient(135deg, #1e40af 0%, #1d4ed8 100%);
            border-left: 4px solid #3b82f6;
        }

        .dark-theme .notification-warning {
            background: linear-gradient(135deg, #92400e 0%, #b45309 100%);
            border-left: 4px solid #f59e0b;
        }
        
        /* File upload preview */
        .file-preview {
            position: relative;
            margin-top: 10px;
            margin-bottom: 10px;
            max-width: 300px;
        }
        
        .file-preview img {
            width: 100%;
            border-radius: 8px;
            border: 2px solid var(--input-border);
        }
        
        .file-preview-remove {
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--user-message-gradient-start);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .file-upload-progress {
            height: 4px;
            background: var(--input-border);
            width: 100%;
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .file-upload-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--user-message-gradient-start), var(--user-message-gradient-end));
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Image in user/AI messages */
        .message-image {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        @keyframes slide-in {
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fade-out {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container glass-effect">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="flex items-center mb-8">
                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center mr-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold">StudyMate AI</h1>
                    <p class="text-sm opacity-80">Trợ lý học tập thông minh</p>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-lg font-semibold mb-4">Tính năng chính</h3>
                
                <div class="feature-card cursor-pointer" onclick="insertCommand('@skill ')">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <span class="font-medium">Phân tích kỹ năng</span>
                    </div>
                    <p class="text-sm opacity-75">@skill [chủ đề]</p>
                </div>

                <div class="feature-card cursor-pointer" onclick="insertCommand('@resource ')">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                        <span class="font-medium">Tài nguyên học tập</span>
                    </div>
                    <p class="text-sm opacity-75">@resource [chủ đề]</p>
                </div>

                <div class="feature-card cursor-pointer" onclick="insertCommand('@schedule ')">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span class="font-medium">Lên lịch học</span>
                    </div>
                    <p class="text-sm opacity-75">@schedule [việc] [thời gian]</p>
                </div>
                
                <div class="feature-card cursor-pointer" onclick="document.getElementById('file-input').click()">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span class="font-medium">Giải bài tập qua ảnh</span>
                    </div>
                    <p class="text-sm opacity-75">Tải ảnh bài tập của bạn</p>
                </div>
            </div>

            <div class="mt-auto pt-6">
                <div class="bg-white bg-opacity-10 rounded-lg p-3">
                    <div class="flex items-center mb-2">
                        <span class="status-indicator"></span>
                        <span class="text-sm font-medium">Trạng thái: Hoạt động</span>
                    </div>
                    <p class="text-xs opacity-75">Sẵn sàng hỗ trợ học tập của bạn 24/7</p>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-chat">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="header-content">
                    <!-- Back Button -->
                    <button id="back-button" class="back-button">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        Quay lại
                    </button>
                    
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-3">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="font-semibold text-gray-800 dark:text-gray-100">Cuộc trò chuyện với StudyMate AI</h2>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Nhấn vào các tính năng bên trái để bắt đầu</p>
                        </div>
                    </div>
                </div>
                
                <div class="header-actions">
                    <!-- Theme Toggle Button -->
                    <button id="theme-toggle" class="theme-toggle" title="Chuyển đổi chế độ sáng/tối">
                        <!-- Sun icon for dark mode -->
                        <svg id="sun-icon" class="hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <!-- Moon icon for light mode -->
                        <svg id="moon-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                        </svg>
                    </button>
                    
                    <button class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chat-messages" class="chat-messages">
                <div class="command-hint">
                    <strong>� Mẹo:</strong> Sử dụng các lệnh như @skill Python, @resource Machine Learning, hoặc @schedule Học toán 19:00 để nhận hỗ trợ chuyên biệt!
                </div>
                
                <div class="message-bubble ai-message">
                    <p>Chào bạn! Tôi là StudyMate AI - trợ lý học tập thông minh của bạn. Tôi có thể giúp bạn:</p>
                    <ul class="mt-2 space-y-1">
                        <li>📚 Phân tích kỹ năng và tạo lộ trình học</li>
                        <li>🔍 Tìm kiếm tài nguyên học tập</li>
                        <li>⏰ Lên lịch học tập</li>
                        <li>💬 Trả lời các câu hỏi học thuật</li>
                        <li>📷 Giải bài tập qua hình ảnh</li>
                    </ul>
                    <p class="mt-3">Hãy thử hỏi tôi điều gì đó, tải lên ảnh bài tập, hoặc click vào các tính năng ở sidebar!</p>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="chat-input-area">
                <!-- File Preview Area -->
                <div id="file-preview-container" class="hidden">
                    <div class="file-preview">
                        <img id="image-preview" src="" alt="Image Preview">
                        <button id="remove-file" class="file-preview-remove">×</button>
                        <div class="file-upload-progress">
                            <div id="upload-progress-bar" class="file-upload-progress-bar"></div>
                        </div>
                    </div>
                </div>
                <div class="input-container">
                    <button id="attachment-btn" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13.5"></path>
                        </svg>
                    </button>
                    <textarea 
                        id="message-input" 
                        class="message-input" 
                        placeholder="Nhập tin nhắn của bạn... hoặc tải lên ảnh bài tập để được giải"
                        rows="1"></textarea>
                    <button id="send-button" class="send-button">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification System Container -->
    <div id="notification-container" class="notification-container"></div>

    <input type="file" id="file-input" accept="image/*" class="hidden">

    <script>
        // API Key - Replace with your actual Gemini API key
        const MY_GEMINI_API_KEY = "AIzaSyDtRKIetyfABd1n9FuRp2zbXjkwfpSeC9E"; // Updated API Key

        // DOM Elements
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const fileInput = document.getElementById('file-input');
        const attachmentBtn = document.getElementById('attachment-btn');
        const backButton = document.getElementById('back-button');
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const htmlElement = document.documentElement;
        const notificationContainer = document.getElementById('notification-container');
        const filePreviewContainer = document.getElementById('file-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeFileButton = document.getElementById('remove-file');
        const uploadProgressBar = document.getElementById('upload-progress-bar');

        let chatHistory = [];
        let isLoading = false;
        let currentImageData = null;
        
        // Store the initial welcome message
        const welcomeMessage = chatMessages.innerHTML;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            messageInput.focus();
            autoResizeTextarea();
            loadThemePreference();
            
            // Show welcome notification
            setTimeout(() => {
                showInfoNotification("Chào mừng!", "Bắt đầu trải nghiệm học tập với StudyMate AI.");
            }, 1000);
        });

        // Theme toggle functionality
        function loadThemePreference() {
            const savedTheme = localStorage.getItem('studymate-theme');
            if (savedTheme === 'dark') {
                enableDarkTheme();
            } else {
                enableLightTheme();
            }
        }
        
        function enableDarkTheme() {
            htmlElement.classList.remove('light-theme');
            htmlElement.classList.add('dark-theme');
            sunIcon.classList.remove('hidden');
            moonIcon.classList.add('hidden');
            localStorage.setItem('studymate-theme', 'dark');
        }
        
        function enableLightTheme() {
            htmlElement.classList.remove('dark-theme');
            htmlElement.classList.add('light-theme');
            moonIcon.classList.remove('hidden');
            sunIcon.classList.add('hidden');
            localStorage.setItem('studymate-theme', 'light');
        }
        
        function toggleTheme() {
            if (htmlElement.classList.contains('light-theme')) {
                enableDarkTheme();
                showInfoNotification("Chế độ tối", "Đã chuyển sang chế độ tối.");
            } else {
                enableLightTheme();
                showInfoNotification("Chế độ sáng", "Đã chuyển sang chế độ sáng.");
            }
        }
        
        themeToggle.addEventListener('click', toggleTheme);

        // Auto-resize textarea
        function autoResizeTextarea() {
            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto';
                messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
            });
        }

        // Insert command helper
        function insertCommand(command) {
            messageInput.value = command;
            messageInput.focus();
            messageInput.setSelectionRange(command.length, command.length);
        }

        // Add message to chat
        function addMessage(content, isUser = false, hasImage = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble ${isUser ? 'user-message' : 'ai-message'}`;
            
            if (hasImage && content.imageUrl) {
                const img = document.createElement('img');
                img.src = content.imageUrl;
                img.className = 'message-image';
                img.alt = 'Uploaded image';
                messageDiv.appendChild(img);
            }
            
            const textDiv = document.createElement('div');
            textDiv.innerHTML = formatMessage(content.text || content);
            messageDiv.appendChild(textDiv);
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // Format message with basic markdown
        function formatMessage(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code class="bg-gray-100 px-1 rounded">$1</code>')
                .replace(/\n/g, '<br>');
        }

        // Scroll to bottom
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Set loading state
        function setLoading(loading) {
            isLoading = loading;
            sendButton.disabled = loading;
            
            if (loading) {
                sendButton.innerHTML = '<div class="spinner"></div>';
            } else {
                sendButton.innerHTML = `
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                `;
            }
        }

        // Handle AI commands
        async function handleCommand(command, args) {
            const prompts = {
                skill: `Với vai trò là một chuyên gia phân tích kỹ năng AI, hãy cung cấp một phân tích ngắn gọn về các kỹ năng chính cần thiết cho lĩnh vực "${args}" và đề xuất một lộ trình học tập đơn giản (3-5 bước). Phản hồi bằng tiếng Việt.`,
                resource: `Với vai trò là một trợ lý học tập AI, hãy tóm tắt các khái niệm cốt lõi của "${args}" trong 2-3 câu và đề xuất 3-5 loại tài nguyên học tập (ví dụ: sách, khóa học online, video hướng dẫn, bài viết blog). Phản hồi bằng tiếng Việt.`,
                schedule: `Đã ghi nhận lịch học của bạn: **${args}**. Trong một ứng dụng thực tế, tôi sẽ nhắc nhở bạn vào thời điểm đó.`
            };

            if (command === 'schedule') {
                showSuccessNotification("Lịch học đã tạo!", `Đã lên lịch: ${args}`);
                return prompts.schedule;
            }

            const prompt = prompts[command];
            if (!prompt) {
                showErrorNotification("Lệnh không hợp lệ", `Lệnh "@${command}" không được hỗ trợ.`);
                return `Lệnh "@${command}" không hợp lệ. Các lệnh hỗ trợ: @skill, @resource, @schedule.`;
            }

            showInfoNotification("Đang xử lý", `Đang truy vấn thông tin về ${args}...`);
            return await callGeminiAPI(prompt);
        }

        // Call Gemini API
        async function callGeminiAPI(message, imageData = null) {
            if (!MY_GEMINI_API_KEY || MY_GEMINI_API_KEY === "YOUR_API_KEY_HERE") {
                showErrorNotification("Lỗi API", "Vui lòng cấu hình khóa API Gemini trong mã nguồn.");
                return "Lỗi: Vui lòng cấu hình Khóa API Gemini của bạn trong mã nguồn.";
            }

            try {
                let parts = [{ text: message }];
                
                // Always use gemini-2.0-flash for all requests
                const apiEndpoint = "gemini-2.0-flash"; 
                
                if (imageData) {
                    parts.push({
                        inlineData: {
                            mimeType: imageData.mimeType,
                            data: imageData.base64
                        }
                    });
                }

                const payload = {
                    contents: [{ role: "user", parts: parts }]
                };

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${apiEndpoint}:generateContent?key=${MY_GEMINI_API_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                if (!response.ok) {
                    // Handle API error
                    const errorData = await response.json();
                    console.error("API error details:", errorData);
                    
                    if (response.status === 404) {
                        throw new Error(`API không tồn tại. Vui lòng kiểm tra cấu hình API.`);
                    } else {
                        throw new Error(`API Error: ${response.status} - ${errorData?.error?.message || 'Unknown error'}`);
                    }
                }

                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else if (result.error) {
                    throw new Error(`API Error: ${result.error.message}`);
                } else {
                    showWarningNotification("Phản hồi rỗng", "Không nhận được nội dung từ API.");
                    return "Xin lỗi, tôi không thể tạo phản hồi lúc này. Vui lòng thử lại.";
                }
            } catch (error) {
                console.error("Error in API call:", error);
                showErrorNotification("Lỗi API", error.message);
                return `${error.message}. Vui lòng thử lại với khóa API hợp lệ hoặc kiểm tra kết nối mạng.`;
            }
        }

        // Reset chat to initial state
        function resetChat() {
            chatMessages.innerHTML = welcomeMessage;
            chatHistory = [];
            messageInput.value = '';
            messageInput.style.height = 'auto';
            messageInput.focus();
            
            showInfoNotification("Cuộc trò chuyện mới", "Đã xóa lịch sử và bắt đầu cuộc trò chuyện mới.");
        }

        // Handle file input
        fileInput.addEventListener('change', handleFileUpload);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showErrorNotification("Lỗi tệp tin", "Chỉ hỗ trợ tải lên các tệp hình ảnh.");
                return;
            }
            
            const reader = new FileReader();
            reader.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percentLoaded = Math.round((e.loaded / e.total) * 100);
                    uploadProgressBar.style.width = percentLoaded + '%';
                }
            };
            
            reader.onload = (e) => {
                // Show file preview
                imagePreview.src = e.target.result;
                filePreviewContainer.classList.remove('hidden');
                
                // Store the image data for sending to API
                currentImageData = {
                    base64: e.target.result.split(',')[1],
                    mimeType: file.type
                };
                
                // Show successful upload notification
                showSuccessNotification(
                    "Đã tải lên thành công", 
                    `Đã tải lên ${file.name}. Hãy nhập mô tả hoặc câu hỏi về bài tập này.`
                );
                
                // Set input focus with prompt
                messageInput.value = "Vui lòng giải bài tập này giúp tôi: ";
                messageInput.focus();
                messageInput.selectionStart = messageInput.value.length;
                messageInput.selectionEnd = messageInput.value.length;
                
                // Reset the file input so the same file can be selected again
                fileInput.value = '';
            };
            
            reader.onerror = () => {
                showErrorNotification("Lỗi đọc tệp", "Không thể đọc tệp hình ảnh. Vui lòng thử lại.");
                fileInput.value = '';
            };
            
            // Start reading the file
            filePreviewContainer.classList.remove('hidden');
            uploadProgressBar.style.width = '0%';
            reader.readAsDataURL(file);
        }
        
        // Remove file
        removeFileButton.addEventListener('click', () => {
            filePreviewContainer.classList.add('hidden');
            currentImageData = null;
            fileInput.value = '';
        });

        // Send message
        async function sendMessage() {
            const message = messageInput.value.trim();
            if ((!message && !currentImageData) || isLoading) return;

            // Create content object for display
            const userContent = {
                text: message || "Vui lòng giải bài tập trong hình ảnh này."
            };
            
            // If we have an image, add it to content
            const hasImage = !!currentImageData;
            if (hasImage) {
                userContent.imageUrl = imagePreview.src;
            }
            
            // Add user message
            addMessage(userContent, true, hasImage);
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Hide file preview after sending
            if (hasImage) {
                filePreviewContainer.classList.add('hidden');
            }
            
            setLoading(true);

            try {
                let response;
                
                // Check if it's a command
                const commandMatch = message.match(/^@(\w+)\s*(.*)/);
                if (commandMatch && !hasImage) {
                    const [, command, args] = commandMatch;
                    response = await handleCommand(command.toLowerCase(), args.trim());
                } else if (hasImage) {
                    // For image uploads, we need a special prompt
                    const imagePrompt = message || "Vui lòng giải bài tập trong hình ảnh này và giải thích chi tiết các bước làm. Nếu có nhiều cách giải, vui lòng đưa ra cách giải hiệu quả nhất.";
                    response = await callGeminiAPI(imagePrompt, currentImageData);
                    currentImageData = null; // Reset after use
                } else {
                    response = await callGeminiAPI(message);
                }

                addMessage(response, false);
            } catch (error) {
                addMessage(`Đã xảy ra lỗi: ${error.message}. Vui lòng thử lại hoặc kiểm tra cấu hình API.`, false);
                showErrorNotification("Lỗi", error.message || "Không thể xử lý tin nhắn. Vui lòng thử lại.");
            } finally {
                setLoading(false);
                messageInput.focus();
            }
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        attachmentBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
    // Back button functionality
backButton.addEventListener('click', function() {
    window.location.href = 'index.html'; // Thay đổi 'trang-khac.html' bằng URL bạn muốn chuyển đến
});
        // Notification System Functions
        // Notification Types
        const NOTIFICATION_TYPES = {
            SUCCESS: 'success',
            ERROR: 'error',
            INFO: 'info',
            WARNING: 'warning'
        };

        // Function to create a new notification
        function createNotification(type, title, message, duration = 5000) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            // Get the appropriate icon for the notification type
            const iconSvg = getNotificationIcon(type);
            
            // Create notification content
            notification.innerHTML = `
                <div class="notification-icon">${iconSvg}</div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close">×</button>
            `;
            
            // Add the notification to the container
            notificationContainer.appendChild(notification);
            
            // Set up close button functionality
            const closeButton = notification.querySelector('.notification-close');
            closeButton.addEventListener('click', () => {
                removeNotification(notification);
            });
            
            // Auto-remove notification after duration
            setTimeout(() => {
                removeNotification(notification);
            }, duration);
            
            return notification;
        }

        // Function to remove a notification
        function removeNotification(notification) {
            notification.style.animation = 'fade-out 0.5s forwards';
            setTimeout(() => {
                if (notification.parentNode === notificationContainer) {
                    notificationContainer.removeChild(notification);
                }
            }, 500);
        }

        // Function to get the appropriate icon SVG for each notification type
        function getNotificationIcon(type) {
            switch(type) {
                case NOTIFICATION_TYPES.SUCCESS:
                    return `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`;
                case NOTIFICATION_TYPES.ERROR:
                    return `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`;
                case NOTIFICATION_TYPES.WARNING:
                    return `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>`;
                case NOTIFICATION_TYPES.INFO:
                default:
                    return `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`;
            }
        }

        // Convenience functions for different notification types
        function showSuccessNotification(title, message, duration = 5000) {
            return createNotification(NOTIFICATION_TYPES.SUCCESS, title, message, duration);
        }

        function showErrorNotification(title, message, duration = 5000) {
            return createNotification(NOTIFICATION_TYPES.ERROR, title, message, duration);
        }

        function showInfoNotification(title, message, duration = 5000) {
            return createNotification(NOTIFICATION_TYPES.INFO, title, message, duration);
        }

        function showWarningNotification(title, message, duration = 5000) {
            return createNotification(NOTIFICATION_TYPES.WARNING, title, message, duration);
        }

        // Make insertCommand available globally
        window.insertCommand = insertCommand;
    </script>
</body>
</html>
