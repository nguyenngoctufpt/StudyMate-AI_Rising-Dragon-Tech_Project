<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Quản Lý Lịch Học - StudyMate AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Các biến màu tùy chỉnh */
        :root {
            --primary-blue: #3b82f6; /* Tailwind blue-500 */
            --dark-blue: #1d4ed8; /* Tailwind blue-700 */
            --light-blue: #bfdbfe; /* Tailwind blue-200 */
            --accent-pink: #ec4899; /* Tailwind pink-500 */
            --background-light: #f3f4f6; /* Tailwind gray-100 for web background */
            --card-background: #ffffff; /* White */
            --text-primary: #1f2937; /* Tailwind gray-900 */
            --text-secondary: #6b7280; /* Tailwind gray-500 */
            --border-color: #e5e7eb; /* Tailwind gray-200 */
            --indigo-500: #6366f1;
            --indigo-600: #4f46e5;
            --green-500: #10b981;
            --green-600: #059669;
            --green-700: #047857;
            --red-500: #ef4444;
            --red-600: #dc2626;
        }

        /* Dark Mode variables */
        html.dark {
            --primary-blue: #63b3ed;
            --dark-blue: #3182ce;
            --light-blue: #2c5282;
            --accent-pink: #f687b3;
            --background-light: #2d3748; /* Darker gray for dark background */
            --card-background: #4a5568; /* Slightly lighter dark gray for cards */
            --text-primary: #e2e8f0; /* Light gray text */
            --text-secondary: #a0aec0; /* Medium gray text */
            --border-color: #2d3748; /* Dark border */
            --indigo-500: #805ad5;
            --indigo-600: #6b46c1;
            --green-500: #48bb78;
            --green-600: #38a169;
            --green-700: #2f855a;
            --red-500: #fc8181;
            --red-600: #e53e3e;
        }


        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-light);
            display: flex;
            flex-direction: column; /* Allow header and main content to stack */
            align-items: center; /* Center app-container */
            min-height: 100vh;
            margin: 0;
            padding: 2rem 1rem; /* Add some padding around the app */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease; /* Smooth transition for theme change */
            color: var(--text-primary); /* Apply default text color */
        }

        .app-container {
            width: 100%;
            max-width: 1280px; /* Max width for web layout */
            background-color: var(--card-background);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* Softer shadow for web */
            border-radius: 1rem; /* Slightly less rounded for web */
            overflow: hidden; /* Keep this for rounded corners */
            display: flex;
            flex-direction: column;
            position: relative;
            transition: background-color 0.3s ease, box-shadow 0.3s ease; /* Smooth transition for theme change */
        }

        .detail-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--indigo-500));
            color: white;
            padding: 1rem 1.5rem; /* Adjusted padding for web */
            display: flex;
            justify-content: space-between; /* Align items with space between */
            align-items: center;
            font-size: 1.375rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 10;
            transition: background 0.3s ease, box-shadow 0.3s ease; /* Smooth transition for theme change */
        }
        .detail-header .header-title-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .detail-header .app-logo {
            font-size: 1.75rem; /* Example logo size */
        }


        .detail-header .back-icon {
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .detail-header .back-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }
        .detail-header .back-icon:active {
            transform: scale(0.95);
        }
        /* Theme toggle button specific styling */
        #themeToggleButton {
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 9999px; /* Fully rounded */
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
        }

        #themeToggleButton:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        #themeToggleButton:active {
            transform: scale(0.95);
        }
        #themeToggleButton svg {
            color: white; /* Icons always white on gradient header */
            transition: transform 0.3s ease; /* Smooth icon spin */
        }
        /* Rotate sun icon slightly for visual interest in dark mode */
        html.dark #sunIcon {
            transform: rotate(30deg);
        }
        /* Rotate moon icon slightly for visual interest in light mode */
        html:not(.dark) #moonIcon {
            transform: rotate(-30deg);
        }

        .detail-header .detail-title { /* This is now the main title */
            font-weight: 600;
            flex-grow: 1;
            text-align: left; /* Align to left within its group */
        }

        /* Upcoming Class Notification Banner */
        #upcomingClassNotification {
            background-color: var(--primary-blue);
            color: white;
            padding: 0.75rem 1.5rem;
            text-align: center;
            font-size: 0.95rem;
            font-weight: 500;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            margin: 0 1.5rem; /* Match main content padding */
            transform: translateY(0); /* Default state */
            opacity: 1;
            transition: transform 0.5s ease-out, opacity 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 9; /* Below header */
            overflow: hidden; /* For running text effect */
            white-space: nowrap; /* For running text effect */
        }
        #upcomingClassNotification.hidden {
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none; /* Make it unclickable when hidden */
            margin: 0; /* Remove margin when hidden to collapse space */
        }
        #upcomingClassNotification .notification-text-content {
            display: inline-block; /* For running text effect */
            animation: marquee-notification 15s linear infinite; /* Running text animation */
            padding-left: 100%; /* Start off-screen */
            animation-play-state: paused; /* Pause by default */
        }
        #upcomingClassNotification.active .notification-text-content {
            animation-play-state: running; /* Run when active */
        }

        @keyframes marquee-notification {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        #upcomingClassNotification .close-notification-btn {
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 1rem;
            line-height: 1;
            border: none;
            color: white;
            margin-left: 1rem;
        }
        #upcomingClassNotification .close-notification-btn:hover {
            background: rgba(255,255,255,0.4);
        }


        .detail-main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            scroll-behavior: smooth;
            display: grid; /* Use grid for layout on larger screens */
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); /* Responsive columns */
            gap: 1.5rem; /* Gap between grid items */
        }

        @media (max-width: 768px) {
            .detail-main-content {
                grid-template-columns: 1fr; /* Single column for mobile/tablet */
                padding: 1rem;
            }
            .app-container {
                border-radius: 0; /* Full screen on mobile */
                margin:0;
                max-height: 100vh;
            }
            body {
                padding: 0;
            }
            .detail-header {
                border-radius: 0;
                padding: 1rem 1.25rem;
                font-size: 1.25rem;
            }
            .detail-header .detail-title {
                font-size: 1.25rem;
                margin-right: calc(1.25rem + 0.75rem + 0.5rem * 2); /* Adjust offset for smaller back icon */
            }
            .detail-header .back-icon {
                font-size: 1.25rem;
                padding: 0.5rem;
            }
            .card {
                padding: 1rem; /* Slightly reduce card padding on smaller screens */
            }
            .card-title {
                font-size: 1.125rem;
            }
            .action-buttons-group .primary-button {
                min-width: 100px; /* Smaller min-width for buttons on mobile */
                font-size: 0.875rem;
            }
            #upcomingClassNotification {
                margin: 0; /* No margin on small screens */
                border-radius: 0;
            }
        }


        .detail-main-content::-webkit-scrollbar,
        .add-schedule-modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .detail-main-content::-webkit-scrollbar-track,
        .add-schedule-modal-content::-webkit-scrollbar-track {
            background: var(--background-light);
            border-radius: 10px;
        }
        .detail-main-content::-webkit-scrollbar-thumb,
        .add-schedule-modal-content::-webkit-scrollbar-thumb {
            background: var(--text-secondary);
            border-radius: 10px;
            border: 2px solid var(--background-light);
        }
        .detail-main-content::-webkit-scrollbar-thumb:hover,
        .add-schedule-modal-content::-webkit-scrollbar-thumb:hover {
            background: var(--text-primary);
        }

        .card {
            background-color: var(--card-background);
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.07);
            padding: 1.25rem;
            margin-bottom: 0;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            color: var(--text-primary);
        }
        .schedule-table-card {
            grid-column: span 1 / span 1;
        }
        @media (min-width: 1024px) {
            .schedule-table-card {
                grid-column: span 2 / span 2;
            }
        }


        .card-title {
            color: var(--dark-blue);
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            letter-spacing: -0.01em;
            transition: color 0.3s ease;
        }

        .card-title.text-indigo-600 {
            color: var(--indigo-600);
        }


        .card-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.6;
            font-weight: 400;
            transition: color 0.3s ease;
        }

        .schedule-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .secondary-button {
            background-color: var(--card-background);
            color: var(--primary-blue);
            border: 1px solid var(--primary-blue);
            border-radius: 0.375rem;
            padding: 0.5rem 0.875rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.15s ease, box-shadow 0.15s ease, border-color 0.3s ease;
        }
        .secondary-button:hover {
            background-color: var(--light-blue);
            color: var(--dark-blue);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .secondary-button:active {
            transform: translateY(0px);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }


        .current-day-display {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .table-responsive {
            overflow-x: auto;
            margin-top: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            transition: border-color 0.3s ease;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        .schedule-table thead tr {
            background-color: var(--background-light); /* Use a themed background */
            color: var(--text-primary);
            text-align: left;
            font-weight: 600;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .schedule-table th, .schedule-table td {
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--border-color);
            white-space: nowrap;
            transition: border-color 0.3s ease;
        }

        .schedule-table tbody tr:nth-child(even) {
            background-color: var(--background-light); /* Use themed background */
        }
        html.dark .schedule-table tbody tr:nth-child(even) {
            background-color: var(--card-background); /* Lighter than background-light in dark mode */
        }

        .schedule-table tbody tr:hover {
            background-color: var(--light-blue); /* Lighter highlight on hover */
        }
        html.dark .schedule-table tbody tr:hover {
            background-color: rgba(99, 179, 237, 0.2); /* Transparent blue for dark hover */
        }
        
        .schedule-table .actions-cell {
            display: flex;
            gap: 0.375rem;
            justify-content: center;
            align-items: center;
        }
        .schedule-table .action-icon {
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.3rem;
            border-radius: 50%;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.15s ease;
        }
        .schedule-table .action-icon:hover {
            background-color: var(--light-blue);
            color: var(--primary-blue);
            transform: scale(1.1);
        }
        .schedule-table .action-icon.delete-icon:hover {
            background-color: var(--red-500); /* Use themed red */
            color: white; /* White icon on red background */
        }
        .schedule-table .reminder-icon {
            color: var(--accent-pink);
            font-size: 1rem;
        }


        .table-caption {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 0.75rem;
            transition: color 0.3s ease;
        }

        .reminder-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding: 0.5rem 0;
            border-top: 1px dashed var(--border-color);
            transition: border-color 0.3s ease;
        }

        .reminder-option label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.375rem;
            transition: color 0.3s ease;
        }

        .filter-select {
            width: auto;
            padding: 0.5rem 2rem 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            color: var(--text-primary);
            background-color: var(--card-background);
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236b7280%22%20d%3D%22M287%2C67.3l-141.2%2C141.2L5.65%2C67.3c-4.75-4.75-12.45-4.75-17.2%2C0L-14.4%2C80.15c-4.75%2C4.75-4.75%2C12.45%2C0%2C17.2l158.4%2C158.4c4.75%2C4.75%2C12.45%2C4.75%2C17.2%2C0l158.4-158.4c4.75-4.75%2C4.75-12.45%2C0-17.2l-22.85-22.85C299.45%2C62.55%2C291.75%2C62.55%2C287%2C67.3z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 0.75rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease, color 0.3s ease;
        }
        .filter-select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        /* Dark mode select arrow color */
        html.dark .filter-select {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23a0aec0%22%20d%3D%22M287%2C67.3l-141.2%2C141.2L5.65%2C67.3c-4.75-4.75-12.45-4.75-17.2%2C0L-14.4%2C80.15c-4.75%2C4.75-4.75%2C12.45%2C0%2C17.2l158.4%2C158.4c4.75%2C4.75%2C12.45%2C4.75%2C17.2%2C0l158.4-158.4c4.75-4.75%2C4.75-12.45%2C0-17.2l-22.85-22.85C299.45%2C62.55%2C291.75%2C62.55%2C287%2C67.3z%22%2F%3E%3C%2Fsvg%3E');
        }


        .primary-button {
            background: linear-gradient(135deg, var(--primary-blue), var(--indigo-500));
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.625rem 1.25rem;
            font-size: 0.9375rem;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }

        .primary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            background: linear-gradient(135deg, var(--dark-blue), var(--indigo-600));
        }
        .primary-button:active {
            transform: translateY(0px);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.15);
        }

        .primary-button.import-button {
            background: linear-gradient(135deg, var(--green-500), var(--green-600));
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
        }
        .primary-button.import-button:hover {
            background: linear-gradient(135deg, var(--green-600), var(--green-700));
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }


        /* Action buttons group at the bottom */
        .action-buttons-group {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.25rem;
            flex-wrap: wrap;
            justify-content: center;
            grid-column: 1 / -1; /* Make this group span all columns in the main grid */
        }

        .action-buttons-group .primary-button {
            flex: 1;
            min-width: 150px; /* Adjusted for web */
        }

        /* Styles for Notes Card */
        .notes-card ul {
            list-style: none;
            padding: 0;
        }
        .note-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--background-light);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            margin-bottom: 0.5rem;
        }
        .note-item:hover {
            background-color: var(--light-blue);
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
        }
        html.dark .note-item:hover {
            background-color: rgba(99, 179, 237, 0.2);
        }

        .note-item .note-text {
            flex-grow: 1;
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.5;
            text-align: left;
            word-break: break-word;
            transition: color 0.3s ease;
        }
        .note-item .note-actions {
            display: flex;
            gap: 0.375rem;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }
        .note-item .note-action-icon {
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.3rem;
            border-radius: 50%;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.15s ease;
        }
        .note-item .note-action-icon:hover {
            background-color: var(--light-blue);
            color: var(--primary-blue);
            transform: scale(1.1);
        }
        .note-item .note-action-icon.delete-note-icon:hover {
            background-color: var(--red-500);
            color: white;
        }

        /* AI Suggested Notes styles */
        .ai-suggested-notes-section {
            margin-top: 1.25rem;
            padding-top: 1.25rem;
            border-top: 1px dashed var(--border-color);
            transition: border-color 0.3s ease;
        }
        .ai-suggested-notes-section .card-title {
            font-size: 1.1rem;
            color: var(--primary-blue);
            margin-bottom: 0.625rem;
            transition: color 0.3s ease;
        }
        .ai-suggested-notes-list {
            list-style: none;
            padding: 0;
            margin-top: 0.75rem;
        }
        .ai-suggested-note-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #e0f2fe; /* light blue background */
            border: 1px solid #bae6fd; /* lighter blue border */
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        html.dark .ai-suggested-note-item {
            background-color: var(--light-blue); /* themed light blue in dark mode */
            border-color: var(--primary-blue); /* themed primary blue in dark mode */
        }
        .ai-suggested-note-item .note-text {
            flex-grow: 1;
            font-size: 0.875rem;
            color: var(--dark-blue); /* darker blue text */
            font-style: italic;
            text-align: left;
            word-break: break-word;
            transition: color 0.3s ease;
        }
        .ai-suggested-note-item .add-suggested-note-button {
            background-color: var(--green-500);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.15s ease;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }
        .ai-suggested-note-item .add-suggested-note-button:hover {
            background-color: var(--green-600);
            transform: scale(1.05);
        }
        .get-ai-suggestions-button {
            margin-top: 1rem;
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 9999px;
            padding: 0.625rem 1.25rem;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.15s ease;
            display: block;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .get-ai-suggestions-button:hover {
            background-color: var(--dark-blue);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* NEW AI Daily Focus Card Styles */
        .ai-focus-card .card-title {
            color: var(--indigo-600);
            font-size: 1.25rem;
            transition: color 0.3s ease;
        }
        .ai-focus-card p, .ai-focus-card li {
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }
        .ai-focus-card .animate-pulse, .chart-analysis-output .animate-pulse, #import-modal-status-message.animate-pulse {
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        .ai-focus-card .text-red-500, .chart-analysis-output .text-red-500, #import-modal-status-message.text-red-500 {
            color: var(--red-600);
            transition: color 0.3s ease;
        }
        #import-modal-status-message.text-green-500 {
            color: var(--green-600);
            transition: color 0.3s ease;
        }
        .ai-focus-card ul {
            list-style-position: inside;
            padding-left: 0.5rem;
        }
        .ai-focus-card ul li {
            margin-bottom: 0.25rem;
        }


        /* Chart specific styles */
        .chart-container {
            position: relative;
            height: 280px; /* Slightly taller for web */
            width: 100%;
            margin-top: 1.25rem;
        }
        .chart-analysis-output {
            background-color: #eef2ff;
            border: 1px solid var(--indigo-500);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-top: 1rem;
            font-size: 0.875rem;
            color: var(--indigo-600);
            line-height: 1.6;
            font-weight: 500;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 50px;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        html.dark .chart-analysis-output {
            background-color: rgba(128, 90, 213, 0.2); /* Transparent purple for dark mode */
            border-color: var(--indigo-500);
            color: var(--text-primary);
        }
        .chart-analysis-output strong {
            color: var(--indigo-600);
            font-weight: 600;
            transition: color 0.3s ease;
        }
        .chart-analysis-output ul {
            list-style-type: disc;
            list-style-position: inside;
            padding-left: 0.5rem;
            margin-top: 0.5rem;
        }
        .chart-analysis-output li {
            margin-bottom: 0.25rem;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }


        /* Modal styles (for Add/Edit Schedule) */
        .add-schedule-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.65);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .add-schedule-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .add-schedule-modal-content {
            background-color: var(--card-background);
            padding: 1.5rem;
            padding-right: 0.75rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            max-width: 420px; /* Max width for the modal itself */
            width: 90%;
            text-align: left;
            transform: translateY(-20px) scale(0.95);
            opacity: 0;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s ease, background-color 0.3s ease, color 0.3s ease;
            position: relative;
            max-height: 90vh; /* Adjusted max height for web */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            color: var(--text-primary);
        }
        .add-schedule-modal-overlay.active .add-schedule-modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .add-schedule-modal-inner-content {
            padding-right: 0.75rem;
            flex-grow: 1;
        }

        .add-schedule-modal-content h3 {
            font-size: 1.375rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.25rem;
            text-align: center;
            transition: color 0.3s ease;
        }
        .add-schedule-modal-content .import-from-file-section h4 {
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            text-align: center;
            transition: color 0.3s ease;
        }

        .add-schedule-modal-content .form-group {
            margin-bottom: 0.875rem;
            text-align: left;
        }
        .add-schedule-modal-content label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.375rem;
            transition: color 0.3s ease;
        }
        .add-schedule-modal-content input[type="text"],
        .add-schedule-modal-content input[type="time"],
        .add-schedule-modal-content input[type="range"],
        .add-schedule-modal-content select,
        .add-schedule-modal-content input[type="file"] {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            color: var(--text-primary);
            background-color: var(--background-light); /* Themed background */
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease, color 0.3s ease;
        }
        .add-schedule-modal-content input[type="file"] {
            padding: 0.5rem;
            border: 1px dashed var(--primary-blue);
            transition: border-color 0.3s ease;
        }
        .add-schedule-modal-content input[type="file"]::file-selector-button {
            margin-right: 0.5rem;
            border: none;
            background: var(--primary-blue);
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            color: white;
            cursor: pointer;
            transition: background-color .15s ease-in-out;
        }
        .add-schedule-modal-content input[type="file"]::file-selector-button:hover {
            background: var(--dark-blue);
        }


        .add-schedule-modal-content input[type="range"] {
            padding: 0.25rem 0;
        }
        .add-schedule-modal-content input[type="text"]:focus,
        .add-schedule-modal-content input[type="time"]:focus,
        .add-schedule-modal-content input[type="range"]:focus,
        .add-schedule-modal-content select:focus,
        .add-schedule-modal-content input[type="file"]:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .add-schedule-modal-content select {
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236b7280%22%20d%3D%22M287%2C67.3l-141.2%2C141.2L5.65%2C67.3c-4.75-4.75-12.45-4.75-17.2%2C0L-14.4%2C80.15c-4.75%2C4.75-4.75%2C12.45%2C0%2C17.2l158.4%2C158.4c4.75%2C4.75%2C12.45%2C4.75%2C17.2%2C0l158.4-158.4c4.75-4.75%2C4.75-12.45%2C0-17.2l-22.85-22.85C299.45%2C62.55%2C291.75%2C62.55%2C287%2C67.3z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 0.75rem;
        }
        html.dark .add-schedule-modal-content select {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23a0aec0%22%20d%3D%22M287%2C67.3l-141.2%2C141.2L5.65%2C67.3c-4.75-4.75-12.45-4.75-17.2%2C0L-14.4%2C80.15c-4.75%2C4.75-4.75%2C12.45%2C0%2C17.2l158.4%2C158.4c4.75%2C4.75%2C12.45%2C4.75%2C17.2%2C0l158.4-158.4c4.75-4.75%2C4.75-12.45%2C0-17.2l-22.85-22.85C299.45%2C62.55%2C291.75%2C62.55%2C287%2C67.3z%22%2F%3E%3C%2Fsvg%3E');
        }

        .add-schedule-modal-content .duration-display {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-left: 0.5rem;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        .add-schedule-modal-content .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 1.25rem;
            padding-bottom: 0.5rem;
        }
        .add-schedule-modal-content .modal-buttons button {
            flex: 1;
            padding: 0.625rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .add-schedule-modal-content .modal-buttons .save-button {
            background-color: var(--green-500);
            color: white;
        }
        .add-schedule-modal-content .modal-buttons .save-button:hover {
            background-color: var(--green-600);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .add-schedule-modal-content .modal-buttons .cancel-button {
            background-color: var(--border-color); /* Themed border-color */
            color: var(--text-primary); /* Themed primary text */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .add-schedule-modal-content .modal-buttons .cancel-button:hover {
            background-color: var(--text-secondary); /* Themed secondary text as hover */
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        #import-modal-status-message {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        .import-from-file-section .file-format-instructions {
            margin-top: 0.75rem;
            padding: 0.625rem;
            background-color: var(--light-blue); /* Themed light blue */
            border: 1px solid var(--primary-blue); /* Themed primary blue */
            border-radius: 0.375rem;
            font-size: 0.75rem;
            color: var(--dark-blue); /* Themed dark blue */
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .import-from-file-section .file-format-instructions p strong {
            font-weight: 600;
        }
        .import-from-file-section .file-format-instructions ul {
            list-style-type: disc;
            list-style-position: inside;
            margin-top: 0.25rem;
        }


        /* General Confirmation Modal styles */
        #general-confirmation-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.65);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #general-confirmation-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .general-confirmation-modal-content {
            background-color: var(--card-background);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            max-width: 350px;
            width: 90%;
            text-align: center;
            transform: translateY(-20px) scale(0.95);
            opacity: 0;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s ease, background-color 0.3s ease, color 0.3s ease;
            color: var(--text-primary);
        }
        #general-confirmation-modal-overlay.active .general-confirmation-modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .general-confirmation-modal-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            transition: color 0.3s ease;
        }
        .general-confirmation-modal-content p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 1.25rem;
            transition: color 0.3s ease;
        }
        .general-confirmation-modal-content .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .general-confirmation-modal-content .modal-buttons button {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }
        .general-confirmation-modal-content .modal-buttons .confirm-button {
            background-color: var(--red-500);
            color: white;
        }
        .general-confirmation-modal-content .modal-buttons .confirm-button:hover {
            background-color: var(--red-600);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .general-confirmation-modal-content .modal-buttons .cancel-button {
            background-color: var(--border-color);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .general-confirmation-modal-content .modal-buttons .cancel-button:hover {
            background-color: var(--text-secondary);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Notification Modal Styles */
        #notification-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2002;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        #notification-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .notification-content {
            background-color: var(--card-background);
            padding: 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            max-width: 320px;
            width: 90%;
            text-align: center;
            transform: translateY(-20px) scale(0.95);
            opacity: 0;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s ease-in-out, background-color 0.3s ease, color 0.3s ease;
            color: var(--text-primary);
            position: relative;
        }
        #notification-modal-overlay.active .notification-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        #notification-close-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 9999px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        #notification-close-button:hover {
            background-color: var(--background-light);
            color: var(--text-primary);
        }
        .notification-message {
            font-size: 0.9375rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        /* Notification types for message styling */
        .notification-content.success .notification-message { color: var(--green-600); }
        .notification-content.error .notification-message { color: var(--red-600); }
        .notification-content.info .notification-message { color: var(--primary-blue); }
        .notification-content.warning .notification-message { color: #f59e0b; } /* amber-500 */


        /* Responsive adjustments for smaller screens (mobile-first was the original, so these are minor tweaks or overrides) */
        @media (max-width: 768px) { /* Tablet and below */
            .app-container {
                border-radius: 0;
                margin:0;
                max-height: 100vh; /* Ensure it fits viewport height */
            }
            body {
                padding: 0;
            }
            .detail-header {
                border-radius: 0;
                padding: 1rem 1.25rem;
                font-size: 1.25rem;
            }
            .detail-header .detail-title {
                font-size: 1.25rem;
                margin-right: calc(1.25rem + 0.75rem + 0.5rem * 2); /* Adjust offset for smaller back icon */
            }
            .detail-header .back-icon {
                font-size: 1.25rem;
                padding: 0.5rem;
            }
            .detail-main-content {
                padding: 1rem;
            }
            .card {
                padding: 1rem; /* Slightly reduce card padding on smaller screens */
            }
            .card-title {
                font-size: 1.125rem;
            }
            .action-buttons-group .primary-button {
                min-width: 100px; /* Smaller min-width for buttons on mobile */
                font-size: 0.875rem;
            }
        }
        /* Study Timer specific styles */
        .study-timer-card .timer-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-blue);
            text-align: center;
            margin: 1rem 0;
            font-variant-numeric: tabular-nums; /* Align numbers in monospace */
            transition: color 0.3s ease;
        }
        .study-timer-card .timer-buttons {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .study-timer-card .timer-buttons button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .study-timer-card .timer-buttons .start-button {
            background-color: var(--green-500);
            color: white;
        }
        .study-timer-card .timer-buttons .start-button:hover {
            background-color: var(--green-600);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .study-timer-card .timer-buttons .pause-button {
            background-color: #f6e05e; /* Tailwind yellow-400 */
            color: #744210; /* Dark brown for contrast */
        }
        html.dark .study-timer-card .timer-buttons .pause-button {
            background-color: #ecc94b; /* Darker yellow for dark mode */
            color: #2d3748;
        }
        .study-timer-card .timer-buttons .pause-button:hover {
            background-color: #fbd38d; /* Tailwind yellow-300 */
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        html.dark .study-timer-card .timer-buttons .pause-button:hover {
            background-color: #f6ad55;
        }
        .study-timer-card .timer-buttons .reset-button {
            background-color: var(--red-500);
            color: white;
        }
        .study-timer-card .timer-buttons .reset-button:hover {
            background-color: var(--red-600);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .study-timer-card .session-type {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="detail-header">
            <div class="header-title-group">
                <button class="back-icon" onclick="window.location.href = 'index.html'" aria-label="Quay lại trang chủ">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </button>
                <span class="detail-title">AI Quản Lý Lịch Học</span>
            </div>
            <!-- Light/Dark Mode Toggle Button -->
            <button id="themeToggleButton" aria-label="Chuyển đổi chế độ sáng tối">
                <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.325 6.775l-.707-.707M6.707 6.707l-.707-.707m10.606 0l-.707.707M7.414 17.293l-.707.707M12 18a6 6 0 100-12 6 6 0 000 12z" />
                </svg>
                <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </header>

        <!-- Upcoming Class Notification Banner -->
        <div id="upcomingClassNotification" class="hidden">
            <i class="fas fa-bell animate-pulse mr-2"></i>
            <span id="notificationMessage" class="notification-text-content"></span>
            <button class="close-notification-btn" id="closeNotificationBtn">&times;</button>
        </div>

        <main class="detail-main-content">
            <div class="card function-intro-card">
                <h3 class="card-title">Lịch Học Thông Minh</h3>
                <p class="card-description">AI giúp bạn theo dõi lịch học chi tiết, đảm bảo bạn không bỏ lỡ bất kỳ buổi nào.</p>

                <div class="schedule-controls">
                    <button class="secondary-button" id="prevDay" aria-label="Ngày trước"><i class="fas fa-chevron-left"></i></button>
                    <span id="currentDay" class="current-day-display">Hôm nay, 27/05/2025</span>
                    <button class="secondary-button" id="nextDay" aria-label="Ngày sau"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>

            <div class="card schedule-table-card">
                <div class="table-responsive">
                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Môn</th>
                                <th>GV</th>
                                <th>Phòng</th>
                                <th>Ca</th>
                                <th>Bắt đầu</th>
                                <th>Thời lượng</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="card notes-card">
                <h3 class="card-title">Ghi chú & Việc cần làm hôm nay</h3>
                <div class="flex items-center space-x-2 mb-4">
                    <input type="text" id="newNoteInput" placeholder="Thêm ghi chú hoặc việc cần làm..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-gray-700">
                    <button id="addNoteButton" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg transition duration-200" aria-label="Thêm ghi chú">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <ul id="notesList" class="space-y-2">
                    </ul>

                <div id="aiSuggestedNotesSection" class="ai-suggested-notes-section">
                    <h4 class="card-title">Gợi ý ghi chú từ AI</h4>
                    <ul id="aiSuggestedNotesList" class="ai-suggested-notes-list">
                        </ul>
                    <button id="getAiSuggestionsButton" class="get-ai-suggestions-button">Nhận gợi ý từ AI</button>
                </div>
            </div>

            <div class="card ai-focus-card" id="aiFocusCard">
                <div id="aiFocusContent">
                    <h4 class="card-title text-lg font-semibold mb-2 text-indigo-600">🚀 AI Daily Focus</h4>
                    <p class="text-sm text-gray-600 animate-pulse">AI is thinking... <i class="fas fa-spinner fa-spin ml-1"></i></p>
                </div>
            </div>

            <!-- New: Study Session Timer Card -->
            <div class="card study-timer-card">
                <h3 class="card-title">Bộ Đếm Giờ Học Tập</h3>
                <p class="card-description">Sử dụng bộ đếm này để tập trung vào các phiên học hiệu quả.</p>
                <div id="timerDisplay" class="timer-display">25:00</div>
                <div id="sessionType" class="session-type">Phiên học</div>
                <div class="timer-buttons">
                    <button id="startTimerBtn" class="start-button">Bắt đầu</button>
                    <button id="pauseTimerBtn" class="pause-button">Tạm dừng</button>
                    <button id="resetTimerBtn" class="reset-button">Đặt lại</button>
                </div>
                <input type="range" id="studyDurationSlider" min="5" max="60" step="5" value="25" class="w-full mt-4">
                <div class="text-center text-sm text-gray-600 mt-2">
                    Thời gian học: <span id="studyDurationDisplay">25 phút</span>
                </div>
            </div>


            <div class="card chart-analysis-card">
                <h3 class="card-title">Phân Tích Lịch Học Tổng Quan (AI)</h3>
                <p class="card-description">Biểu đồ dưới đây thể hiện phân bổ thời gian học tập của bạn theo môn học trong tuần qua (dữ liệu mẫu), cùng với phân tích tự động từ AI.</p>
                <div class="chart-container">
                    <canvas id="studyTimeChart"></canvas>
                </div>
                <div id="chartAnalysisOutput" class="chart-analysis-output mt-4">
                    <p class="text-sm text-gray-600 animate-pulse">AI đang phân tích biểu đồ tổng quan... <i class="fas fa-spinner fa-spin ml-1"></i></p>
                </div>
            </div>

            <div class="card reminder-settings-card">
                <h3 class="card-title">Cài Đặt Nhắc Nhở</h3>
                <p class="card-description">Nhận thông báo tự động trước giờ học.</p>
                <div class="reminder-option">
                    <label for="reminderTime">Nhắc nhở trước:</label>
                    <select id="reminderTime" class="filter-select">
                        <option value="5">5 phút</option>
                        <option value="15" selected>15 phút</option>
                        <option value="30">30 phút</option>
                        <option value="60">1 tiếng</option>
                    </select>
                </div>
            </div>

            <div class="action-buttons-group">
                <button class="primary-button" id="saveReminderSettings">Lưu Cài Đặt</button>
                <button class="primary-button add-schedule-button">Thêm Lịch Học Mới</button>
                <button class="primary-button export-schedule-button" id="exportScheduleButton">Xuất Lịch Học CSV</button>
            </div>

        </main>
    </div>

    <div id="add-schedule-modal-overlay" class="add-schedule-modal-overlay">
        <div class="add-schedule-modal-content">
            <div class="add-schedule-modal-inner-content">
                <h3 id="addScheduleModalTitle">Thêm Lịch Học Mới</h3>
                <form id="add-schedule-form" class="space-y-4">
                    <input type="hidden" id="editingScheduleId">
                    <div class="form-group">
                        <label for="newSubject">Môn học:</label>
                        <input type="text" id="newSubject" placeholder="Ví dụ: Lập trình Web" required>
                    </div>
                    <div class="form-group">
                        <label for="newTeacher">Giảng viên:</label>
                        <input type="text" id="newTeacher" placeholder="Ví dụ: Thầy Bình">
                    </div>
                    <div class="form-group">
                        <label for="newRoom">Phòng học:</label>
                        <input type="text" id="newRoom" placeholder="Ví dụ: F201">
                    </div>
                    <div class="form-group">
                        <label for="newSession">Ca học:</label>
                        <select id="newSession">
                            <option value="Ca 1" data-duration="120">Ca 1 (07:30 - 09:30)</option>
                            <option value="Ca 2" data-duration="120">Ca 2 (09:40 - 11:40)</option>
                            <option value="Ca 3" data-duration="120">Ca 3 (11:50 - 13:50)</option>
                            <option value="Ca 4" data-duration="120">Ca 4 (13:30 - 15:30)</option>
                            <option value="Ca 5" data-duration="120">Ca 5 (15:40 - 17:40)</option>
                            <option value="Tùy chỉnh" data-duration="90">Tùy chỉnh</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newTime">Thời gian bắt đầu:</label>
                        <input type="time" id="newTime" value="07:30" required>
                    </div>
                    <div class="form-group">
                        <label for="newDuration">Thời lượng: <span id="newDurationDisplay" class="duration-display">90 phút</span></label>
                        <input type="range" id="newDuration" min="30" max="240" step="15" value="90">
                    </div>
                    <div class="modal-buttons">
                        <button type="submit" class="save-button" id="saveScheduleButton">Lưu Lịch Học</button>
                        <button type="button" class="cancel-button" id="cancelAddSchedule">Hủy</button>
                    </div>
                </form>

                <div class="my-4 border-t border-gray-200"></div> <div class="import-from-file-section">
                    <h4 class="text-md font-semibold text-gray-700 mb-3 text-center">Hoặc Nhập từ File</h4>
                    <div class="form-group">
                        <label for="scheduleFileModal">Chọn file CSV (.csv):</label>
                        <input type="file" id="scheduleFileModal" accept=".csv" class="mt-1">
                    </div>
                    <div id="import-modal-status-message" class="text-sm mt-2 mb-3 text-center"></div>
                    <button type="button" id="processImportFromModalButton" class="primary-button import-button w-full mb-2">Tiến hành Nhập từ File</button>
                    <div class="file-format-instructions">
                        <p><strong>Hướng dẫn định dạng file CSV:</strong></p>
                        <ul>
                            <li>Cột (theo thứ tự): Môn,GV,Phòng,Ca,Thời gian (HH:MM),Thời lượng (phút)</li>
                            <li>Dòng đầu tiên có thể là tiêu đề (sẽ được bỏ qua).</li>
                            <li>Ví dụ: Lập trình Web,Thầy Bình,F201,Ca 1,07:30,120</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="general-confirmation-modal-overlay" class="general-confirmation-modal-overlay">
        <div class="general-confirmation-modal-content">
            <h3 id="confirmationModalTitle">Xác nhận hành động</h3>
            <p id="confirmationModalMessage">Bạn có chắc chắn muốn thực hiện hành động này?</p>
            <div class="modal-buttons">
                <button id="confirmActionButton" class="confirm-button">Xác nhận</button>
                <button id="cancelActionButton" class="cancel-button">Hủy</button>
            </div>
        </div>
    </div>

    <div id="notification-modal-overlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-[2002] opacity-0 invisible transition-opacity duration-300 ease-in-out">
        <div class="notification-content bg-white p-6 rounded-xl shadow-xl max-w-xs w-11/12 text-center transform -translate-y-5 opacity-0 transition-all duration-300 ease-in-out relative">
            <button id="notification-close-button" class="absolute top-2 right-2 bg-transparent border-none text-gray-400 text-xl cursor-pointer p-1 rounded-full hover:bg-gray-100 hover:text-gray-700 transition-colors duration-200" aria-label="Close notification">&times;</button>
            <p class="notification-message text-base font-medium mb-4"></p>
        </div>
    </div>

    <script>
        // Hàm showNotification (đã được cung cấp để hiển thị thông báo)
        const notificationModalOverlay = document.getElementById('notification-modal-overlay');
        const notificationContent = notificationModalOverlay.querySelector('.notification-content');
        const notificationMessage = notificationModalOverlay.querySelector('.notification-message');
        const notificationCloseButton = document.getElementById('notification-close-button');

        const showNotification = (message, type = 'info', duration = 3000) => {
            notificationMessage.textContent = message;
            notificationContent.classList.remove('success', 'error', 'info', 'warning');
            if (type) {
                notificationContent.classList.add(type);
            }
            
            notificationModalOverlay.classList.add('active');
            setTimeout(() => {
                notificationContent.classList.add('active');
            }, 10);

            if (duration > 0) {
                setTimeout(() => {
                    hideNotification();
                }, duration);
            }
        };

        const hideNotification = () => {
            notificationContent.classList.remove('active');
            notificationContent.addEventListener('transitionend', () => {
                notificationModalOverlay.classList.remove('active');
            }, { once: true });
        };
        notificationCloseButton.addEventListener('click', hideNotification);
        notificationModalOverlay.addEventListener('click', (event) => {
            if (event.target === notificationModalOverlay) {
                hideNotification();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const currentDayDisplay = document.getElementById('currentDay');
            const prevDayBtn = document.getElementById('prevDay');
            const nextDayBtn = document.getElementById('nextDay');
            const scheduleBody = document.getElementById('scheduleBody');
            const reminderTimeSelect = document.getElementById('reminderTime');
            const saveReminderSettingsBtn = document.getElementById('saveReminderSettings');
            const addScheduleButton = document.querySelector('.add-schedule-button');
            const exportScheduleButton = document.getElementById('exportScheduleButton'); // New: Export button
            const upcomingClassNotificationBanner = document.getElementById('upcomingClassNotification'); // New: Notification banner
            const upcomingNotificationMessage = document.getElementById('notificationMessage'); // New: Notification message span
            const closeUpcomingNotificationBtn = document.getElementById('closeNotificationBtn'); // New: Close notification button
            const themeToggleButton = document.getElementById('themeToggleButton'); // Existing: Theme toggle button
            const sunIcon = document.getElementById('sunIcon'); // Existing: Sun icon
            const moonIcon = document.getElementById('moonIcon'); // Existing: Moon icon
            
            // Chart elements
            const studyTimeChartCanvas = document.getElementById('studyTimeChart');
            const chartAnalysisOutput = document.getElementById('chartAnalysisOutput');

            // Add/Edit Schedule Modal elements
            const addScheduleModalOverlay = document.getElementById('add-schedule-modal-overlay');
            const addScheduleModalTitle = document.getElementById('addScheduleModalTitle');
            const addScheduleForm = document.getElementById('add-schedule-form');
            const cancelAddScheduleButton = document.getElementById('cancelAddSchedule');
            const saveScheduleButton = document.getElementById('saveScheduleButton');
            const editingScheduleIdInput = document.getElementById('editingScheduleId');
            const newSubjectInput = document.getElementById('newSubject');
            const newTeacherInput = document.getElementById('newTeacher');
            const newRoomInput = document.getElementById('newRoom');
            const newSessionSelect = document.getElementById('newSession');
            const newTimeInput = document.getElementById('newTime');
            const newDurationSlider = document.getElementById('newDuration');
            const newDurationDisplay = document.getElementById('newDurationDisplay');

            // Import Schedule elements (now inside Add Schedule Modal)
            const scheduleFileModalInput = document.getElementById('scheduleFileModal');
            const processImportFromModalButton = document.getElementById('processImportFromModalButton');
            const importModalStatusMessage = document.getElementById('import-modal-status-message');


            // General Confirmation Modal elements
            const generalConfirmationModalOverlay = document.getElementById('general-confirmation-modal-overlay');
            const confirmationModalTitle = document.getElementById('confirmationModalTitle');
            const confirmationModalMessage = document.getElementById('confirmationModalMessage');
            const confirmActionButton = document.getElementById('confirmActionButton');
            const cancelActionButton = document.getElementById('cancelActionButton');

            // Notes elements
            const newNoteInput = document.getElementById('newNoteInput');
            const addNoteButton = document.getElementById('addNoteButton');
            const notesList = document.getElementById('notesList');
            const aiSuggestedNotesList = document.getElementById('aiSuggestedNotesList');
            const getAiSuggestionsButton = document.getElementById('getAiSuggestionsButton');
            let editingNoteId = null;

            // AI Daily Focus elements
            const aiFocusContent = document.getElementById('aiFocusContent');

            // Study Timer elements
            const timerDisplay = document.getElementById('timerDisplay'); // New
            const sessionTypeDisplay = document.getElementById('sessionType'); // New
            const startTimerBtn = document.getElementById('startTimerBtn'); // New
            const pauseTimerBtn = document.getElementById('pauseTimerBtn'); // New
            const resetTimerBtn = document.getElementById('resetTimerBtn'); // New
            const studyDurationSlider = document.getElementById('studyDurationSlider'); // New
            const studyDurationDisplay = document.getElementById('studyDurationDisplay'); // New

            let currentDate = new Date(); // Lấy ngày hiện tại một cách động
            let currentConfirmAction = null;

            // Study Timer variables
            let timerInterval;
            let timeLeft; // in seconds
            let isRunning = false;
            let isBreak = false;
            let studyDuration = 25 * 60; // default 25 minutes
            const breakDuration = 5 * 60; // default 5 minutes
            let notificationTimeoutId; // For upcoming class notification dismissal


            // Mock data for schedule (can be expanded)
            const mockSchedule = {
                "2025-06-15": [ // Using today's date for relevant mock data
                    { id: 1, subject: "Lập trình Web (HTML/CSS)", teacher: "Thầy Bình", room: "F201", session: "Ca 1", time: "07:30", duration: 120 },
                    { id: 2, subject: "Toán Cao Cấp 1", teacher: "Cô Lan", room: "A305", session: "Ca 2", time: "09:40", duration: 120 },
                    { id: 3, subject: "Cấu trúc dữ liệu & GT", teacher: "Thầy Hùng", room: "F302", session: "Ca 4", time: "13:30", duration: 120 }
                ],
                "2025-06-16": [
                    { id: 101, subject: "AI Development Basics", teacher: "Prof. Gemini", room: "Online", session: "Ca 1", time: "09:00", duration: 90 },
                    { id: 102, subject: "Project StudyMate", teacher: "Self-Study", room: "Home", session: "Ca 3", time: "14:00", duration: 180 }
                ],
                "2025-06-17": [
                    { id: 4, subject: "Kinh tế vi mô", teacher: "Cô Mai", room: "B102", session: "Ca 1", time: "07:30", duration: 120 },
                    { id: 5, subject: "Tiếng Anh 2", teacher: "Thầy An", room: "C203", session: "Ca 3", time: "11:50", duration: 105 }
                ],
                "2025-06-18": [
                    { id: 6, subject: "Hệ điều hành", teacher: "Thầy Nam", room: "F205", session: "Ca 2", time: "09:40", duration: 120 }
                ]
            };

            // New mock data for notes
            const mockNotes = {
                "2025-06-15": [ // Using today's date for relevant mock data
                    { id: 1, text: "Hoàn thành bài tập lớn môn Lập trình Web" },
                    { id: 2, text: "Ôn tập chương 3 Toán Cao Cấp" }
                ],
                "2025-06-16": [
                    { id: 201, text: "Review AI Daily Focus feature" },
                    { id: 202, text: "Prepare for tomorrow's Microeconomics class" }
                ],
                "2025-06-17": [
                    { id: 3, text: "Đọc tài liệu về Kinh tế vi mô" }
                ]
            };

            // Function to generate AI suggested notes based on schedule (RULE-BASED for this section)
            const generateAISuggestedNotes = (date) => {
                const dateKey = date.toISOString().slice(0, 10);
                const dailySchedule = mockSchedule[dateKey] || [];
                const suggestions = [];

                if (dailySchedule.length > 0) {
                    dailySchedule.forEach(item => {
                        suggestions.push(`Chuẩn bị bài tập cho môn ${item.subject}.`);
                        suggestions.push(`Đọc trước tài liệu môn ${item.subject}.`);
                    });
                    suggestions.push(`Kiểm tra lại lịch học ngày ${formatDateDisplay(date)}.`);
                    suggestions.push(`Sắp xếp bàn học gọn gàng.`);
                    suggestions.push(`Ưu tiên công việc quan trọng và khẩn cấp liên quan đến học tập.`);
                    suggestions.push(`Lên kế hoạch cho các dự án dài hạn.`);
                    suggestions.push(`Xác định và loại bỏ các hoạt động gây xao nhãng.`);
                } else {
                    suggestions.push(`Tìm kiếm tài liệu mới để học.`);
                    suggestions.push(`Ôn lại kiến thức cũ.`);
                    suggestions.push(`Lên kế hoạch học tập cho tuần tới.`);
                    suggestions.push(`Dành thời gian cho các hoạt động phát triển bản thân.`);
                }
                return suggestions.slice(0, 3); // Limit to 3 suggestions for brevity
            };


            // Mock data for AI Chart Analysis - This data is used to DRAW the chart. The analysis text will come from AI.
            const mockChartData = {
                labels: ['Lập trình Web', 'Toán Cao Cấp', 'Cấu trúc DL', 'Kinh tế', 'Tiếng Anh', 'Hệ điều hành', 'AI Dev'],
                datasets: [{
                    label: 'Số giờ học trong tuần',
                    data: [8, 6, 7, 4, 5, 3, 5], // Mock hours for each subject
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.8)', /* primary-blue */
                        'rgba(236, 72, 153, 0.8)', /* accent-pink */
                        'rgba(29, 78, 216, 0.8)',  /* dark-blue */
                        'rgba(16, 185, 129, 0.8)', /* green-500 */
                        'rgba(245, 158, 11, 0.8)', /* yellow-500 */
                        'rgba(139, 92, 246, 0.8)', /* purple-500 */
                        'rgba(107, 114, 128, 0.8)' /* gray-500 */
                    ],
                    borderColor: [
                        'rgba(59, 130, 246, 1)',
                        'rgba(236, 72, 153, 1)',
                        'rgba(29, 78, 216, 1)',
                        'rgba(16, 185, 129, 1)',
                        'rgba(245, 158, 11, 1)',
                        'rgba(139, 92, 246, 1)',
                        'rgba(107, 114, 128, 1)'
                    ],
                    borderWidth: 1
                }]
            };

            // Function to format date for display in UI
            const formatDateDisplay = (date) => {
                const options = { weekday: 'long', year: 'numeric', month: 'numeric', day: 'numeric' };
                const today = new Date();
                // For accurate "Hôm nay" in Vietnam timezone (UTC+7)
                const vietnamTimezoneOffset = 7 * 60; // UTC+7 in minutes
                const localTime = today.getTime();
                const localOffset = today.getTimezoneOffset(); // Difference in minutes between UTC and local time
                const utc = localTime + (localOffset * 60 * 1000);
                const todayVietnam = new Date(utc + (vietnamTimezoneOffset * 60 * 1000));

                if (date.getFullYear() === todayVietnam.getFullYear() &&
                    date.getMonth() === todayVietnam.getMonth() &&
                    date.getDate() === todayVietnam.getDate()) {
                    return `Hôm nay, ${date.toLocaleDateString('vi-VN', { day: 'numeric', month: 'numeric', year: 'numeric' })}`;
                }
                return date.toLocaleDateString('vi-VN', options);
            };

            // Helper to format schedule/notes for the AI prompt
            const formatItemsForPrompt = (items, itemType) => {
                if (!items || items.length === 0) {
                    return `No ${itemType} for today.`;
                }
                return items.map(item => {
                    if (itemType === 'classes') return `- ${item.subject} at ${item.time}${item.room ? ` in ${item.room}` : ''}${item.duration ? ` for ${item.duration} minutes` : ''}`;
                    if (itemType === 'notes') return `- "${item.text}"`;
                    return '';
                }).join('\n');
            };
            
            // --- AI Daily Focus ---
            const generateAndRenderAiFocus = async (date) => {
                if (!aiFocusContent) return;

                aiFocusContent.innerHTML = `
                    <h4 class="card-title text-lg font-semibold mb-2 text-indigo-600">🚀 AI Daily Focus</h4>
                    <p class="text-sm text-gray-600 animate-pulse">AI is thinking... <i class="fas fa-spinner fa-spin ml-1"></i></p>`;

                const dateKey = date.toISOString().slice(0, 10);
                const dailySchedule = mockSchedule[dateKey] || [];
                const dailyNotes = mockNotes[dateKey] || [];

                const formattedDateForPrompt = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const schedulePromptPart = formatItemsForPrompt(dailySchedule, 'classes');
                const notesPromptPart = formatItemsForPrompt(dailyNotes, 'notes');

                const prompt = `You are StudyMate AI, a friendly and encouraging assistant for students. Today is ${formattedDateForPrompt}.
Here is the student's schedule for today:
${schedulePromptPart}

Here are their notes/to-dos for today:
${notesPromptPart}

Please provide the following in a concise and helpful manner, in Vietnamese:
1.  Two or three key focus areas or actionable suggestions for today to help the student be productive and manage their time effectively.
2.  One short, actionable study tip OR a brief motivational quote relevant to a student (also in Vietnamese).

Keep the tone supportive and positive.
If there are no classes, suggest how to use the free day for learning or well-being.
If there are no to-dos, gently encourage planning or reviewing.
Structure your response clearly. For focus areas, use bullet points (e.g., "- Focus on X."). Do not use markdown like ** or *.
Output only the advice, starting directly with the focus areas or suggestions.
Example structure:
- Tập trung hoàn thành [Nhiệm vụ cụ thể].
- Dành thời gian ôn tập [Môn học].
Mẹo: Hãy thử kỹ thuật Pomodoro để học tập trung hơn.
Hoặc
Trích dẫn: "Học, học nữa, học mãi." - V.I. Lenin
`;
                
                if (!prompt || prompt.trim() === "") {
                    console.error("AI Focus: Prompt is empty. Aborting API call.");
                    aiFocusContent.innerHTML = `<h4 class="card-title text-lg font-semibold mb-2 text-indigo-600">🚀 AI Daily Focus</h4> <p class="text-sm text-red-500">Lỗi tạo prompt cho AI.</p>`;
                    return;
                }

                // Khóa API Gemini của bạn:
                const apiKey = "AIzaSyBItc3Wx9TgpHdj6bCdX5-XbpWlpzPB_WM"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                
                console.log("AI Focus - Sending payload:", JSON.stringify(payload, null, 2));


                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error(`AI Focus API Error Details: Status - ${response.status}, URL - ${apiUrl}`);
                        console.error("Full API Response Body for Error:", errorBody); // LOGGING ERROR BODY
                        let userMessage = `AI Focus API request failed with status ${response.status}.`;
                        if (response.status === 400) {
                             userMessage += " (Bad Request - kiểm tra nội dung prompt hoặc payload)";
                        }
                        throw new Error(userMessage + ` Details: ${errorBody}`);
                    }
                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const rawText = result.candidates[0].content.parts[0].text;
                        const formattedText = rawText
                            .split('\n')
                            .map(line => line.trim())
                            .filter(line => line.length > 0)
                            .map(line => {
                                if (line.startsWith('- ')) {
                                    return `<li>${line.substring(2)}</li>`;
                                }
                                return `<p class="text-sm text-gray-700 mb-2">${line}</p>`;
                            })
                            .join('');
                        
                        let finalHtml = '';
                        if (formattedText.includes('<li>')) {
                            finalHtml = `<ul class="list-disc list-inside space-y-1 mb-3">${formattedText.replace(/<p.*?>.*?<\/p>/g, '')}</ul>` +
                                         formattedText.replace(/<ul.*?>.*?<\/ul>/g, '');
                        } else {
                            finalHtml = formattedText;
                        }
                        aiFocusContent.innerHTML = `
                            <h4 class="card-title text-lg font-semibold mb-2 text-indigo-600">🚀 AI Daily Focus</h4>
                            <div class="text-sm text-gray-700 space-y-2">${finalHtml}</div>`;
                    } else {
                           console.error("Unexpected AI Focus API response structure:", result);
                        throw new Error("No content in AI Focus API response or unexpected structure.");
                    }
                } catch (error) {
                    console.error(`Error fetching AI Focus (catch block): URL - ${apiUrl}, Message - ${error.message}`, error.stack ? error.stack : '');
                    let userErrorMessage = "Không thể tải gợi ý từ AI lúc này. Vui lòng thử lại sau.";
                    if (error.message) { // Show more detailed error from throw
                        userErrorMessage = `Lỗi AI Focus: ${error.message}. Vui lòng thử lại.`;
                    }


                    aiFocusContent.innerHTML = `
                        <h4 class="card-title text-lg font-semibold mb-2 text-indigo-600">🚀 AI Daily Focus</h4>
                        <p class="text-sm text-red-500">${userErrorMessage}</p>
                        <button id="retryAiFocusButton" class="mt-2 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-3 rounded-md">Thử lại</button>`;
                    const retryButton = document.getElementById('retryAiFocusButton');
                    if (retryButton) {
                        retryButton.addEventListener('click', () => generateAndRenderAiFocus(currentDate));
                    }
                }
            };

            // --- AI Chart Analysis (for mockChartData - weekly overview) ---
            const generateAndRenderAiChartAnalysis = async (chartDataToAnalyze) => {
                if (!chartAnalysisOutput) return;

                chartAnalysisOutput.innerHTML = `<p class="text-sm text-gray-600 animate-pulse">AI đang phân tích biểu đồ tổng quan... <i class="fas fa-spinner fa-spin ml-1"></i></p>`;

                let chartDataString = "Dữ liệu phân bổ thời gian học hàng tuần (giờ/môn):\n";
                chartDataToAnalyze.labels.forEach((label, index) => {
                    chartDataString += `- ${label}: ${chartDataToAnalyze.datasets[0].data[index]} giờ\n`;
                });
                
                // *** PROMPT ĐÃ ĐƯỢC ĐƠN GIẢN HÓA ***
                const prompt = `Bạn là StudyMate AI, một trợ lý học tập thông minh. Dưới đây là dữ liệu tổng quan về phân bổ thời gian học tập của một sinh viên trong tuần qua (đây là dữ liệu mẫu):
${chartDataString}
Dựa vào dữ liệu trên, hãy đưa ra một phân tích ngắn gọn bằng tiếng Việt. Bao gồm nhận xét về môn học chiếm nhiều/ít thời gian nhất, đánh giá sơ bộ về sự cân bằng thời gian, và một gợi ý chung để sinh viên tối ưu hóa việc học.
Hãy viết một cách tự nhiên, khích lệ và hữu ích. Không cần theo một cấu trúc ví dụ cứng nhắc.
`;
                if (!prompt || prompt.trim() === "") {
                    console.error("AI Chart Analysis: Prompt is empty. Aborting API call.");
                    chartAnalysisOutput.innerHTML = `<p class="text-sm text-red-500">Lỗi tạo prompt cho AI phân tích biểu đồ.</p>`;
                    return;
                }

                // Khóa API Gemini của bạn:
                const apiKey = "AIzaSyBItc3Wx9TgpHdj6bCdX5-XbpWlpzPB_WM"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

                console.log("AI Chart Analysis - Sending payload:", JSON.stringify(payload, null, 2));

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error(`AI Chart Analysis API Error Details: Status - ${response.status}, URL - ${apiUrl}`);
                        console.error("Full API Response Body for 400 Error:", errorBody); // LOGGING ERROR BODY
                        let userMessage = `AI Chart Analysis API request failed with status ${response.status}.`;
                        if (response.status === 400) {
                             userMessage += " (Bad Request - kiểm tra nội dung prompt hoặc payload)";
                        }
                        throw new Error(userMessage + ` Details: ${errorBody}`);
                    }
                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const rawText = result.candidates[0].content.parts[0].text;
                        const formattedText = rawText
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                            .split('\n')
                            .map(line => line.trim())
                            .filter(line => line.length > 0)
                            .map(line => {
                                if (line.startsWith('- ')) {
                                    return `<li>${line.substring(2)}</li>`;
                                }
                                return `<p class="mb-1">${line}</p>`;
                            })
                            .join('');
                        
                        let finalHtml = formattedText;
                        if (formattedText.includes('<li>')) {
                            finalHtml = `<ul class="list-disc list-inside space-y-1">${formattedText.replace(/<p.*?>.*?<\/p>/g, '')}</ul>` +
                                         formattedText.replace(/<ul.*?>.*?<\/ul>/g, '');
                        }

                        chartAnalysisOutput.innerHTML = finalHtml;
                    } else {
                        console.error("Unexpected AI Chart Analysis API response structure:", result);
                        throw new Error("No content in AI Chart Analysis API response or unexpected structure.");
                    }
                } catch (error) {
                    console.error(`Error fetching AI Chart Analysis (catch block): URL - ${apiUrl}, Message - ${error.message}`, error.stack ? error.stack : '');
                    let userErrorMessage = "Không thể tải phân tích biểu đồ từ AI. Vui lòng thử lại sau.";
                    if (error.message) { // Show more detailed error from throw
                        userErrorMessage = `Lỗi AI phân tích biểu đồ: ${error.message}. Vui lòng thử lại.`;
                    }

                    chartAnalysisOutput.innerHTML = `
                        <p class="text-sm text-red-500">${userErrorMessage}</p>
                        <button id="retryAiChartAnalysisButton" class="mt-2 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-3 rounded-md">Thử lại</button>`;
                    
                    const retryButton = document.getElementById('retryAiChartAnalysisButton');
                    if (retryButton) {
                        retryButton.addEventListener('click', () => generateAndRenderAiChartAnalysis(mockChartData));
                    }
                }
            };


            // Function to render schedule for the current date
            const renderSchedule = (date) => {
                currentDayDisplay.textContent = formatDateDisplay(date);
                const dateKey = date.toISOString().slice(0, 10);
                const dailySchedule = mockSchedule[dateKey] || [];

                scheduleBody.innerHTML = '';

                if (dailySchedule.length === 0) {
                    scheduleBody.innerHTML = `<tr><td colspan="8" class="text-center text-gray-500 py-4">Không có lịch học nào cho ngày này.</td></tr>`;
                } else {
                    dailySchedule.forEach((item, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${item.subject}</td>
                            <td>${item.teacher}</td>
                            <td>${item.room}</td>
                            <td>${item.session}</td>
                            <td>${item.time}</td>
                            <td>${item.duration ? item.duration + ' phút' : 'N/A'}</td>
                            <td class="actions-cell">
                                <i class="fas fa-edit action-icon edit-icon" data-id="${item.id}" data-date="${dateKey}" title="Sửa lịch học" aria-label="Sửa lịch học"></i>
                                <i class="fas fa-trash-alt action-icon delete-icon" data-id="${item.id}" data-date="${dateKey}" title="Xóa lịch học" aria-label="Xóa lịch học"></i>
                                <i class="fas fa-bell reminder-icon" data-id="${item.id}" title="Đặt nhắc nhở" aria-label="Đặt nhắc nhở"></i>
                            </td>
                        `;
                        scheduleBody.appendChild(row);
                    });
                }
                
                attachScheduleActionListeners();
                renderNotes(date);
                generateAndRenderAiFocus(date);
                checkUpcomingClasses(); // Check for upcoming classes after rendering schedule
            };

            function attachScheduleActionListeners() {
                document.querySelectorAll('.edit-icon').forEach(icon => {
                    icon.removeEventListener('click', handleEditSchedule);
                    icon.addEventListener('click', handleEditSchedule);
                });

                document.querySelectorAll('.delete-icon').forEach(icon => {
                    icon.removeEventListener('click', handleDeleteSchedule);
                    icon.addEventListener('click', handleDeleteSchedule);
                });

                document.querySelectorAll('.reminder-icon').forEach(icon => {
                    icon.removeEventListener('click', handleReminderIconClick);
                    icon.addEventListener('click', handleReminderIconClick);
                });
            }

            function handleEditSchedule(event) {
                const itemId = parseInt(event.target.dataset.id);
                const itemDateKey = event.target.dataset.date;
                editScheduleItem(itemId, itemDateKey);
            }

            function handleDeleteSchedule(event) {
                const itemId = parseInt(event.target.dataset.id);
                const itemDateKey = event.target.dataset.date;
                showConfirmationModal('Bạn có chắc chắn muốn xóa lịch học này?', () => {
                    deleteScheduleItem(itemId, itemDateKey);
                });
            }
            function handleReminderIconClick(event) {
                const itemId = event.target.dataset.id;
                const scheduleItem = mockSchedule[currentDate.toISOString().slice(0,10)]?.find(item => item.id == itemId);
                if(scheduleItem) {
                    showNotification(`Nhắc nhở cho môn ${scheduleItem.subject} lúc ${scheduleItem.time} sẽ được thiết lập!`, 'info');
                } else {
                    showNotification(`Nhắc nhở cho lịch học ID: ${itemId} sẽ được thiết lập!`, 'info');
                }
            }


            // Function to render notes for the current date
            const renderNotes = (date) => {
                const dateKey = date.toISOString().slice(0, 10);
                const dailyNotes = mockNotes[dateKey] || [];
                notesList.innerHTML = '';
                aiSuggestedNotesList.innerHTML = '';

                if (dailyNotes.length === 0) {
                    notesList.innerHTML = `<p class="text-center text-gray-500 py-2">Không có ghi chú nào cho ngày này.</p>`;
                } else {
                    dailyNotes.forEach(note => {
                        const listItem = document.createElement('li');
                        listItem.classList.add('note-item');
                        listItem.innerHTML = `
                            <span class="note-text">${note.text}</span>
                            <div class="note-actions">
                                <i class="fas fa-edit note-action-icon edit-note-icon" data-id="${note.id}" data-date="${dateKey}" title="Sửa ghi chú" aria-label="Sửa ghi chú"></i>
                                <i class="fas fa-trash-alt note-action-icon delete-note-icon" data-id="${note.id}" data-date="${dateKey}" title="Xóa ghi chú" aria-label="Xóa ghi chú"></i>
                            </div>
                        `;
                        notesList.appendChild(listItem);
                    });
                }
                attachNoteActionListeners();
            };
            
            function attachNoteActionListeners() {
                document.querySelectorAll('.edit-note-icon').forEach(icon => {
                    icon.removeEventListener('click', handleEditNote);
                    icon.addEventListener('click', handleEditNote);
                });

                document.querySelectorAll('.delete-note-icon').forEach(icon => {
                    icon.removeEventListener('click', handleDeleteNote);
                    icon.addEventListener('click', handleDeleteNote);
                });
            }

            function handleEditNote(event) {
                const noteId = parseInt(event.target.dataset.id);
                const noteDateKey = event.target.dataset.date;
                editNote(noteId, noteDateKey);
            }
            function handleDeleteNote(event) {
                const noteId = parseInt(event.target.dataset.id);
                const noteDateKey = event.target.dataset.date;
                showConfirmationModal('Bạn có chắc chắn muốn xóa ghi chú này?', () => {
                    deleteNote(noteId, noteDateKey);
                });
            }


            // Function to add/update a note
            const addOrUpdateNote = () => {
                const noteText = newNoteInput.value.trim();
                if (!noteText) {
                    showNotification('Vui lòng nhập nội dung ghi chú.', 'error');
                    return;
                }

                const dateKey = currentDate.toISOString().slice(0, 10);
                if (!mockNotes[dateKey]) {
                    mockNotes[dateKey] = [];
                }

                if (editingNoteId) {
                    const noteIndex = mockNotes[dateKey].findIndex(note => note.id === editingNoteId);
                    if (noteIndex > -1) {
                        mockNotes[dateKey][noteIndex].text = noteText;
                        showNotification('Ghi chú đã được cập nhật!', 'success');
                    } else {
                        showNotification('Không tìm thấy ghi chú để cập nhật.', 'error');
                    }
                    editingNoteId = null;
                } else {
                    const existingIds = mockNotes[dateKey].map(n => n.id);
                    const newId = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
                    mockNotes[dateKey].push({ id: newId, text: noteText });
                    showNotification('Ghi chú mới đã được thêm!', 'success');
                }
                
                newNoteInput.value = '';
                renderNotes(currentDate);
                generateAndRenderAiFocus(currentDate);
            };

            // Function to edit a note
            const editNote = (noteId, noteDateKey) => {
                const notesForDate = mockNotes[noteDateKey] || [];
                const noteToEdit = notesForDate.find(note => note.id === noteId);
                if (noteToEdit) {
                    newNoteInput.value = noteToEdit.text;
                    editingNoteId = noteId;
                    newNoteInput.focus();
                } else {
                    showNotification('Không tìm thấy ghi chú để sửa.', 'error');
                }
            };

            // Function to delete a note
            const deleteNote = (noteId, noteDateKey) => {
                if (mockNotes[noteDateKey]) {
                    const initialLength = mockNotes[dateKey].length;
                    mockNotes[dateKey] = mockNotes[dateKey].filter(note => note.id !== noteId);
                    if (mockNotes[dateKey].length < initialLength) {
                        renderNotes(currentDate);
                        generateAndRenderAiFocus(currentDate);
                        showNotification('Ghi chú đã được xóa thành công!', 'success');
                    } else {
                        showNotification('Không tìm thấy ghi chú để xóa.', 'error');
                    }
                } else {
                    showNotification('Không tìm thấy ghi chú cho ngày này.', 'error');
                }
            };

            // Function to accept AI suggested note (for the rule-based AI notes section)
            const acceptSuggestedNote = (noteText) => {
                const dateKey = currentDate.toISOString().slice(0, 10);
                if (!mockNotes[dateKey]) {
                    mockNotes[dateKey] = [];
                }
                const existingIds = mockNotes[dateKey].map(n => n.id);
                const newId = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
                mockNotes[dateKey].push({ id: newId, text: noteText });
                showNotification('Gợi ý đã được thêm vào ghi chú của bạn!', 'success');
                renderNotes(currentDate);
                generateAndRenderAiFocus(currentDate);
            };


            // Function to initialize and render the chart
            let studyTimeChartInstance = null;

            const renderStudyTimeChart = () => {
                if (studyTimeChartInstance) {
                    studyTimeChartInstance.destroy();
                }

                studyTimeChartInstance = new Chart(studyTimeChartCanvas, {
                    type: 'bar',
                    data: mockChartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Phân bổ thời gian học tập theo môn (Mẫu)',
                                font: {
                                    size: 16,
                                    weight: 'bold',
                                    family: 'Inter'
                                },
                                color: '#1f2937'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Số giờ',
                                    font: {
                                        size: 14,
                                        family: 'Inter'
                                    },
                                    color: '#1f2937'
                                },
                                ticks: {
                                    font: {
                                        family: 'Inter'
                                    },
                                    color: '#6b7280'
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        family: 'Inter'
                                    },
                                    color: '#6b7280'
                                }
                            }
                        }
                    }
                });
                generateAndRenderAiChartAnalysis(mockChartData);
            };

            // --- General Confirmation Modal Functions ---
            const showConfirmationModal = (message, onConfirmCallback) => {
                confirmationModalTitle.textContent = 'Xác nhận';
                confirmationModalMessage.textContent = message;
                generalConfirmationModalOverlay.classList.add('active');
                generalConfirmationModalOverlay.querySelector('.general-confirmation-modal-content').classList.add('active');
                currentConfirmAction = onConfirmCallback;
            };

            const hideConfirmationModal = () => {
                generalConfirmationModalOverlay.querySelector('.general-confirmation-modal-content').classList.remove('active');
                generalConfirmationModalOverlay.addEventListener('transitionend', () => {
                    generalConfirmationModalOverlay.classList.remove('active');
                    currentConfirmAction = null;
                }, { once: true });
            };

            confirmActionButton.addEventListener('click', () => {
                if (currentConfirmAction) {
                    currentConfirmAction();
                }
                hideConfirmationModal();
            });

            cancelActionButton.addEventListener('click', hideConfirmationModal);


            // Event listeners for day navigation
            prevDayBtn.addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() - 1);
                renderSchedule(currentDate);
            });

            nextDayBtn.addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() + 1);
                renderSchedule(currentDate);
            });

            // Event listener for saving reminder settings
            saveReminderSettingsBtn.addEventListener('click', () => {
                const selectedTime = reminderTimeSelect.value;
                showNotification(`Cài đặt nhắc nhở đã lưu: trước ${selectedTime} phút.`, 'success');
            });

            // Event listener for "Thêm Lịch Học Mới" button - Show modal for adding
            addScheduleButton.addEventListener('click', () => {
                addScheduleForm.reset();
                editingScheduleIdInput.value = '';
                addScheduleModalTitle.textContent = 'Thêm Lịch Học Mới';
                saveScheduleButton.textContent = 'Lưu Lịch Học';
                const firstSessionOption = newSessionSelect.options[newSessionSelect.selectedIndex || 0];
                const defaultDuration = firstSessionOption.dataset.duration || '90';
                newDurationSlider.value = defaultDuration;
                newDurationDisplay.textContent = `${defaultDuration} phút`;
                
                scheduleFileModalInput.value = '';
                importModalStatusMessage.textContent = '';
                importModalStatusMessage.className = 'text-sm mt-2 mb-3 text-center';


                addScheduleModalOverlay.classList.add('active');
                addScheduleModalOverlay.querySelector('.add-schedule-modal-content').classList.add('active');
            });
            
            // Function to populate edit form
            const editScheduleItem = (itemId, itemDateKey) => {
                const scheduleForDate = mockSchedule[itemDateKey] || [];
                const itemToEdit = scheduleForDate.find(item => item.id === itemId);

                if (itemToEdit) {
                    addScheduleModalTitle.textContent = 'Sửa Lịch Học';
                    saveScheduleButton.textContent = 'Cập Nhật Lịch Học';
                    editingScheduleIdInput.value = itemToEdit.id;
                    newSubjectInput.value = itemToEdit.subject;
                    newTeacherInput.value = itemToEdit.teacher;
                    newRoomInput.value = itemToEdit.room;
                    newSessionSelect.value = itemToEdit.session;
                    newTimeInput.value = itemToEdit.time;
                    newDurationSlider.value = itemToEdit.duration || 90;
                    newDurationDisplay.textContent = `${newDurationSlider.value} phút`;

                    scheduleFileModalInput.value = '';
                    importModalStatusMessage.textContent = '';
                    importModalStatusMessage.className = 'text-sm mt-2 mb-3 text-center';


                    addScheduleModalOverlay.classList.add('active');
                    addScheduleModalOverlay.querySelector('.add-schedule-modal-content').classList.add('active');
                } else {
                    showNotification('Không tìm thấy lịch học để sửa.', 'error');
                }
            };

            // Function to delete schedule item
            const deleteScheduleItem = (itemId, itemDateKey) => {
                if (mockSchedule[itemDateKey]) {
                    const initialLength = mockSchedule[itemDateKey].length;
                    mockSchedule[itemDateKey] = mockSchedule[itemDateKey].filter(item => item.id !== itemId);
                    if (mockSchedule[itemDateKey].length < initialLength) {
                        renderSchedule(currentDate);
                        showNotification('Lịch học đã được xóa thành công!', 'success');
                    } else {
                        showNotification('Không tìm thấy lịch học để xóa.', 'error');
                    }
                } else {
                    showNotification('Không tìm thấy lịch học cho ngày này.', 'error');
                }
            };


            // Event listener for "Hủy" button in Add/Edit Schedule Modal
            cancelAddScheduleButton.addEventListener('click', () => {
                addScheduleModalOverlay.querySelector('.add-schedule-modal-content').classList.remove('active');
                addScheduleModalOverlay.addEventListener('transitionend', () => {
                    addScheduleModalOverlay.classList.remove('active');
                    addScheduleForm.reset();
                    editingScheduleIdInput.value = '';
                    scheduleFileModalInput.value = '';
                    importModalStatusMessage.textContent = '';
                    importModalStatusMessage.className = 'text-sm mt-2 mb-3 text-center';
                }, { once: true });
            });

            // Event listener for Add/Edit Schedule Form submission
            addScheduleForm.addEventListener('submit', (event) => {
                event.preventDefault();

                const idStr = editingScheduleIdInput.value;
                const id = idStr ? parseInt(idStr) : null;
                const newSubject = newSubjectInput.value.trim();
                const newTeacher = newTeacherInput.value.trim();
                const newRoom = newRoomInput.value.trim();
                const newSession = newSessionSelect.value;
                const newTime = newTimeInput.value;
                const newDuration = parseInt(newDurationSlider.value);
                
                if (!newSubject || !newTime) {
                    showNotification('Vui lòng nhập đầy đủ Môn học và Thời gian.', 'error');
                    return;
                }

                const dateKey = currentDate.toISOString().slice(0, 10);
                if (!mockSchedule[dateKey]) {
                    mockSchedule[dateKey] = [];
                }

                const scheduleItemData = {
                    subject: newSubject,
                    teacher: newTeacher,
                    room: newRoom,
                    session: newSession,
                    time: newTime,
                    duration: newDuration
                };

                if (id !== null) {
                    const itemIndex = mockSchedule[dateKey].findIndex(item => item.id === id);
                    if (itemIndex > -1) {
                        mockSchedule[dateKey][itemIndex] = { ...scheduleItemData, id: id };
                        showNotification('Lịch học đã được cập nhật thành công!', 'success');
                    } else {
                        showNotification('Không tìm thấy lịch học để cập nhật.', 'error');
                    }
                } else {
                    const existingIds = mockSchedule[dateKey].map(s => s.id);
                    let newId = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
                    while(Object.values(mockSchedule).flat().some(s => s.id === newId)) { // Ensure global uniqueness for simplicity
                        newId++;
                    }
                    mockSchedule[dateKey].push({ ...scheduleItemData, id: newId });
                    showNotification('Lịch học mới đã được thêm thành công!', 'success');
                }

                renderSchedule(currentDate);
                
                // Close modal after saving
                addScheduleModalOverlay.querySelector('.add-schedule-modal-content').classList.remove('active');
                addScheduleModalOverlay.addEventListener('transitionend', () => {
                    addScheduleModalOverlay.classList.remove('active');
                    addScheduleForm.reset();
                    editingScheduleIdInput.value = '';
                    scheduleFileModalInput.value = '';
                    importModalStatusMessage.textContent = '';
                    importModalStatusMessage.className = 'text-sm mt-2 mb-3 text-center';
                }, { once: true });
            });

            // Event listener for add note button
            addNoteButton.addEventListener('click', addOrUpdateNote);
            newNoteInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    addOrUpdateNote();
                }
            });

            // Event listener for "Nhận gợi ý từ AI" button (for RULE-BASED notes section)
            getAiSuggestionsButton.addEventListener('click', () => {
                const suggestedNotes = generateAISuggestedNotes(currentDate);
                aiSuggestedNotesList.innerHTML = '';
                if (suggestedNotes.length === 0) {
                    aiSuggestedNotesList.innerHTML = `<p class="text-center text-gray-500 py-2">Không có gợi ý nào từ AI cho ngày này.</p>`;
                    return;
                }
                suggestedNotes.forEach(text => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('ai-suggested-note-item');
                    listItem.innerHTML = `
                        <span class="note-text">${text}</span>
                        <button class="add-suggested-note-button">Thêm</button>
                    `;
                    aiSuggestedNotesList.appendChild(listItem);

                    listItem.querySelector('.add-suggested-note-button').addEventListener('click', () => {
                        acceptSuggestedNote(text);
                        listItem.remove();
                        if (aiSuggestedNotesList.children.length === 0) {
                            aiSuggestedNotesList.innerHTML = `<p class="text-center text-gray-500 py-2">Đã thêm tất cả gợi ý.</p>`;
                        }
                    });
                });
                showNotification('AI đã tạo gợi ý ghi chú mới!', 'info');
            });

            // Update duration slider and display when session changes
            newSessionSelect.addEventListener('change', (event) => {
                const selectedOption = event.target.options[event.target.selectedIndex];
                const duration = selectedOption.dataset.duration || '90';
                newDurationSlider.value = duration;
                newDurationDisplay.textContent = `${duration} phút`;
            });

            // Update duration display when slider changes
            newDurationSlider.addEventListener('input', (event) => {
                newDurationDisplay.textContent = `${event.target.value} phút`;
            });

            // --- Import Schedule Functionality (Integrated into Add Modal) ---
            processImportFromModalButton.addEventListener('click', () => {
                const file = scheduleFileModalInput.files[0];
                if (!file) {
                    importModalStatusMessage.textContent = 'Vui lòng chọn một file.';
                    importModalStatusMessage.className = 'text-sm mt-2 mb-3 text-center text-red-500';
                    return;
                }

                if (!file.name.toLowerCase().endsWith('.csv')) {
                    importModalStatusMessage.textContent = 'Chỉ hỗ trợ file .csv. Vui lòng kiểm tra lại.';
                    importModalStatusMessage.className = 'text-sm mt-2 mb-3 text-center text-red-500';
                    scheduleFileModalInput.value = '';
                    return;
                }


                importModalStatusMessage.textContent = 'Đang xử lý file...';
                importModalStatusMessage.className = 'text-sm mt-2 mb-3 text-center animate-pulse';
                processImportFromModalButton.disabled = true;
                saveScheduleButton.disabled = true;

                const reader = new FileReader();
                reader.onload = function(event) {
                    const csvData = event.target.result;
                    try {
                        const lines = csvData.split(/\r\n|\n/);
                        const importedItems = [];
                        let isFirstLineHeader = false;
                        if (lines.length > 0) {
                            const firstLineCells = lines[0].split(',');
                            if (firstLineCells.some(cell => cell.trim().toLowerCase().includes("môn") || cell.trim().toLowerCase().includes("subject"))) {
                                isFirstLineHeader = true;
                            }
                        }

                        lines.forEach((line, index) => {
                            if (isFirstLineHeader && index === 0) {
                                return;
                            }
                            if (line.trim() === '') return;

                            const cells = line.split(',');
                            if (cells.length >= 6) {
                                importedItems.push({
                                    subject: cells[0]?.trim() || "Chưa có tên",
                                    teacher: cells[1]?.trim() || "",
                                    room: cells[2]?.trim() || "",
                                    session: cells[3]?.trim() || "Tùy chỉnh",
                                    time: cells[4]?.trim() || "00:00",
                                    duration: parseInt(cells[5]?.trim()) || 90
                                });
                            } else {
                                console.warn(`Skipping line ${index + 1} due to insufficient columns: ${line}`);
                            }
                        });

                        if (importedItems.length === 0 && lines.length > (isFirstLineHeader ? 1 : 0) ) {
                            importModalStatusMessage.textContent = 'Không có dữ liệu hợp lệ trong file hoặc định dạng sai.';
                            importModalStatusMessage.className = 'text-sm mt-2 mb-3 text-center text-red-500';
                            processImportFromModalButton.disabled = false;
                            saveScheduleButton.disabled = false;
                            return;
                        }


                        const dateKey = currentDate.toISOString().slice(0, 10);
                        if (!mockSchedule[dateKey]) {
                            mockSchedule[dateKey] = [];
                        }

                        let importedCount = 0;
                        importedItems.forEach(item => {
                            const existingIds = Object.values(mockSchedule).flat().map(s => s.id);
                            let newId = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
                            while(Object.values(mockSchedule).flat().some(s => s.id === newId)) {
                                newId++;
                            }

                            mockSchedule[dateKey].push({
                                id: newId,
                                subject: item.subject,
                                teacher: item.teacher,
                                room: item.room,
                                session: item.session,
                                time: item.time,
                                duration: item.duration
                            });
                            importedCount++;
                        });

                        importModalStatusMessage.textContent = `Nhập thành công ${importedCount} mục lịch học!`;
                        importModalStatusMessage.className = 'text-sm mt-2 mb-3 text-center text-green-500';
                        renderSchedule(currentDate);

                        setTimeout(() => {
                            cancelAddScheduleButton.click();
                        }, 1500);

                    } catch (e) {
                        console.error("Error parsing CSV:", e);
                        importModalStatusMessage.textContent = 'Lỗi xử lý file CSV. Vui lòng kiểm tra định dạng.';
                        importModalStatusMessage.className = 'text-sm mt-2 mb-3 text-center text-red-500';
                    } finally {
                        processImportFromModalButton.disabled = false;
                        saveScheduleButton.disabled = false;
                        scheduleFileModalInput.value = '';
                    }
                };
                reader.onerror = function() {
                    console.error("Error reading file:", reader.error);
                    importModalStatusMessage.textContent = 'Lỗi đọc file. Vui lòng thử lại.';
                    importModalStatusMessage.className = 'text-sm mt-2 mb-3 text-center text-red-500';
                    processImportFromModalButton.disabled = false;
                    saveScheduleButton.disabled = false;
                    scheduleFileModalInput.value = '';
                };
                reader.readAsText(file);
            });

            // --- Export Schedule to CSV ---
            exportScheduleButton.addEventListener('click', () => {
                const dateKey = currentDate.toISOString().slice(0, 10);
                const dailySchedule = mockSchedule[dateKey] || [];
                
                if (dailySchedule.length === 0) {
                    showNotification('Không có lịch học nào để xuất cho ngày này.', 'warning');
                    return;
                }

                let csvContent = "Môn,Giảng viên,Phòng,Ca,Thời gian,Thời lượng\n"; // CSV Header
                dailySchedule.forEach(item => {
                    const row = `${item.subject},${item.teacher},${item.room},${item.session},${item.time},${item.duration}\n`;
                    csvContent += row;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) { // Feature detection
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `lich_hoc_${dateKey}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showNotification(`Đã xuất lịch học ngày ${formatDateDisplay(currentDate)} sang CSV!`, 'success');
                } else {
                    showNotification('Trình duyệt của bạn không hỗ trợ xuất file trực tiếp.', 'error');
                }
            });

            // --- Upcoming Class Notification Logic ---
            let lastNotifiedClassId = null; // To prevent re-notifying the same class

            const checkUpcomingClasses = async () => { // Made async to await AI call
                const now = new Date();
                const dateKey = currentDate.toISOString().slice(0, 10);
                const dailySchedule = mockSchedule[dateKey] || [];
                const reminderOffsetMinutes = parseInt(reminderTimeSelect.value); // Get user's preferred reminder time

                let upcomingClass = null;

                for (const item of dailySchedule) {
                    // Combine date and time to create a full datetime object for comparison
                    const [hours, minutes] = item.time.split(':').map(Number);
                    const classTime = new Date(currentDate); // Clone current date to avoid modification
                    classTime.setHours(hours, minutes, 0, 0); // Set hours, minutes, seconds, milliseconds

                    const timeUntilClass = classTime.getTime() - now.getTime(); // Difference in milliseconds

                    // Check if class is in the future AND within the reminder window
                    if (timeUntilClass > 0 && timeUntilClass <= reminderOffsetMinutes * 60 * 1000) {
                        // Ensure we don't notify for a class that has just passed the reminder threshold
                        // and also prevent notifying the same class multiple times.
                        if (item.id !== lastNotifiedClassId) {
                             upcomingClass = item;
                             break; // Found the next upcoming class to notify
                        }
                    }
                }

                if (upcomingClass) {
                    const minutesLeft = Math.ceil((classTime.getTime() - now.getTime()) / (60 * 1000));
                    let notificationText = `Buổi học sắp đến: ${upcomingClass.subject} tại ${upcomingClass.room} lúc ${upcomingClass.time}! Còn khoảng ${minutesLeft} phút.`;

                    // Attempt to get AI-powered notification message
                    try {
                        const aiPrompt = `Tạo một lời nhắc nhở ngắn gọn, thân thiện và năng động cho một buổi học sắp diễn ra. Buổi học là "${upcomingClass.subject}" với giáo viên "${upcomingClass.teacher}" tại phòng "${upcomingClass.room}" vào lúc "${upcomingClass.time}". Tin nhắn nên nhấn mạnh sự sẵn sàng. Chỉ cần cung cấp tin nhắn, không thêm lời mở đầu hay kết thúc. Ví dụ: "Nhanh lên! Lập trình Web tại F201 sắp bắt đầu lúc 07:30. Hãy chuẩn bị sẵn sàng nhé!"`;
                        const aiResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: aiPrompt }] }] })
                        });
                        const aiResult = await aiResponse.json();
                        if (aiResult.candidates && aiResult.candidates.length > 0 && aiResult.candidates[0].content && aiResult.candidates[0].content.parts && aiResult.candidates[0].content.parts.length > 0) {
                            notificationText = aiResult.candidates[0].content.parts[0].text.trim();
                            // If AI provides a very short text, append time left for context
                            if (notificationText.length < 50 && !notificationText.includes("phút")) {
                                notificationText += ` Còn khoảng ${minutesLeft} phút.`;
                            }
                        }
                    } catch (aiError) {
                        console.warn("Could not get AI notification message:", aiError);
                        // Fallback to default message if AI call fails
                    }


                    upcomingNotificationMessage.textContent = notificationText;
                    upcomingClassNotificationBanner.classList.remove('hidden');
                    upcomingClassNotificationBanner.classList.add('active'); // Activate running text animation if needed
                    lastNotifiedClassId = upcomingClass.id; // Mark this class as notified
                    
                    // Optionally set a timeout to hide the notification automatically
                    if (notificationTimeoutId) clearTimeout(notificationTimeoutId);
                    notificationTimeoutId = setTimeout(() => {
                        upcomingClassNotificationBanner.classList.remove('active'); // Deactivate animation
                        upcomingClassNotificationBanner.classList.add('hidden');
                        lastNotifiedClassId = null; // Reset notified class after it's hidden
                    }, reminderOffsetMinutes * 60 * 1000); // Hide when class starts or reminder duration ends
                } else {
                    upcomingClassNotificationBanner.classList.remove('active'); // Deactivate animation
                    upcomingClassNotificationBanner.classList.add('hidden');
                    lastNotifiedClassId = null; // Clear if no upcoming classes
                    if (notificationTimeoutId) { // Clear any pending hide timeouts
                        clearTimeout(notificationTimeoutId);
                        notificationTimeoutId = null;
                    }
                }
            };

            closeUpcomingNotificationBtn.addEventListener('click', () => {
                upcomingClassNotificationBanner.classList.remove('active'); // Deactivate animation
                upcomingClassNotificationBanner.classList.add('hidden');
                if (notificationTimeoutId) {
                    clearTimeout(notificationTimeoutId);
                    notificationTimeoutId = null;
                }
                lastNotifiedClassId = null; // Allow notification again if conditions are met later
            });

            // Set up a periodic check for upcoming classes (e.g., every 30 seconds)
            setInterval(checkUpcomingClasses, 30 * 1000); 

            // --- Study Session Timer Logic ---
            timeLeft = studyDuration; // Initialize with default study duration

            const updateTimerDisplay = () => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            };

            const startTimer = () => {
                if (isRunning) return; // Prevent multiple intervals
                isRunning = true;
                startTimerBtn.disabled = true;
                pauseTimerBtn.disabled = false;
                resetTimerBtn.disabled = false;
                studyDurationSlider.disabled = true; // Disable slider when timer is running

                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();

                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        isRunning = false;
                        startTimerBtn.disabled = false;
                        pauseTimerBtn.disabled = true;
                        
                        if (isBreak) {
                            showNotification("Đã hết giờ giải lao! Bắt đầu phiên học mới.", 'info');
                            isBreak = false;
                            timeLeft = studyDuration; // Reset to study duration
                            sessionTypeDisplay.textContent = 'Phiên học';
                        } else {
                            showNotification("Đã hết giờ học! Hãy nghỉ ngơi một chút.", 'success');
                            isBreak = true;
                            timeLeft = breakDuration; // Start break
                            sessionTypeDisplay.textContent = 'Giờ giải lao';
                        }
                        updateTimerDisplay(); // Update display for new session type
                        // Automatically start next session/break after a short delay for notification visibility
                        setTimeout(() => {
                             startTimer();
                        }, 2000); // 2 second delay before auto-starting next session
                    }
                }, 1000);
            };

            const pauseTimer = () => {
                clearInterval(timerInterval);
                isRunning = false;
                startTimerBtn.disabled = false;
                pauseTimerBtn.disabled = true;
                studyDurationSlider.disabled = false; // Enable slider when paused
            };

            const resetTimer = () => {
                clearInterval(timerInterval);
                isRunning = false;
                isBreak = false;
                timeLeft = studyDuration; // Reset to original study duration
                updateTimerDisplay();
                sessionTypeDisplay.textContent = 'Phiên học';
                startTimerBtn.disabled = false;
                pauseTimerBtn.disabled = true;
                resetTimerBtn.disabled = true;
                studyDurationSlider.disabled = false; // Enable slider when reset
            };

            // Event Listeners for Study Timer buttons
            startTimerBtn.addEventListener('click', startTimer);
            pauseTimerBtn.addEventListener('click', pauseTimer);
            resetTimerBtn.addEventListener('click', resetTimer);

            // Study Duration Slider logic
            studyDurationSlider.addEventListener('input', (event) => {
                const newDuration = parseInt(event.target.value);
                studyDuration = newDuration * 60; // Convert minutes to seconds
                studyDurationDisplay.textContent = `${newDuration} phút`;
                if (!isRunning) { // Only update timeLeft if timer is not running
                    timeLeft = studyDuration;
                    updateTimerDisplay();
                }
            });

            // Initial state for timer buttons
            pauseTimerBtn.disabled = true;
            resetTimerBtn.disabled = true;
            updateTimerDisplay(); // Initial display of 25:00

            // Initial render when page loads
            // Sử dụng ngày hiện tại để khởi tạo lịch
            currentDate = new Date(); 
            renderSchedule(currentDate);
            renderStudyTimeChart();

            // Set up theme on load
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.documentElement.classList.toggle('dark', savedTheme === 'dark');
                sunIcon.classList.toggle('hidden', savedTheme === 'dark');
                moonIcon.classList.toggle('hidden', savedTheme === 'light');
            } else {
                // Default to light if no theme saved
                document.documentElement.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }

            themeToggleButton.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isDarkMode = document.documentElement.classList.contains('dark');
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                sunIcon.classList.toggle('hidden', isDarkMode);
                moonIcon.classList.toggle('hidden', !isDarkMode);
            });
        });
    </script>
</body>
</html>
